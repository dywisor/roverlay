<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.10: http://docutils.sourceforge.net/" />
<title>Automatically Generated Overlay of R packages</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7514 2012-09-14 14:27:12Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#introduction" id="id5">1&nbsp;&nbsp;&nbsp;Introduction</a></li>
<li><a class="reference internal" href="#installation" id="id6">2&nbsp;&nbsp;&nbsp;Installation</a><ul class="auto-toc">
<li><a class="reference internal" href="#prerequisites" id="id7">2.1&nbsp;&nbsp;&nbsp;Prerequisites</a></li>
<li><a class="reference internal" href="#via-emerge-gentoo" id="id8">2.2&nbsp;&nbsp;&nbsp;via emerge (Gentoo)</a></li>
<li><a class="reference internal" href="#manual-installation" id="id9">2.3&nbsp;&nbsp;&nbsp;Manual Installation</a></li>
<li><a class="reference internal" href="#using-roverlay-without-installation" id="id10">2.4&nbsp;&nbsp;&nbsp;Using <em>roverlay</em> without installation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-roverlay" id="id11">3&nbsp;&nbsp;&nbsp;Running Roverlay</a><ul class="auto-toc">
<li><a class="reference internal" href="#required-configuration-steps" id="id12">3.1&nbsp;&nbsp;&nbsp;Required configuration steps</a><ul class="auto-toc">
<li><a class="reference internal" href="#extended-configuration-where-to-go-from-here" id="id13">3.1.1&nbsp;&nbsp;&nbsp;Extended Configuration / Where to go from here?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-it" id="id14">3.2&nbsp;&nbsp;&nbsp;Running it</a></li>
<li><a class="reference internal" href="#providing-a-package-mirror" id="id15">3.3&nbsp;&nbsp;&nbsp;Providing a package mirror</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-implementation-overview" id="id16">4&nbsp;&nbsp;&nbsp;Basic Implementation Overview</a><ul class="auto-toc">
<li><a class="reference internal" href="#how-roverlay-works" id="id17">4.1&nbsp;&nbsp;&nbsp;How <em>roverlay</em> works</a></li>
<li><a class="reference internal" href="#expected-overlay-result-structure-of-the-generated-overlay" id="id18">4.2&nbsp;&nbsp;&nbsp;Expected Overlay Result / Structure of the generated overlay</a><ul class="auto-toc">
<li><a class="reference internal" href="#expected-ebuild-result" id="id19">4.2.1&nbsp;&nbsp;&nbsp;Expected Ebuild Result</a></li>
<li><a class="reference internal" href="#expected-metadata-xml-result" id="id20">4.2.2&nbsp;&nbsp;&nbsp;Expected <em>metadata.xml</em> Result</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#repositories-getting-packages" id="id21">5&nbsp;&nbsp;&nbsp;Repositories / Getting Packages</a><ul class="auto-toc">
<li><a class="reference internal" href="#a-word-about-repo-config-files" id="id22">5.1&nbsp;&nbsp;&nbsp;A word about repo config files</a></li>
<li><a class="reference internal" href="#rsync-repos" id="id23">5.2&nbsp;&nbsp;&nbsp;Rsync repos</a></li>
<li><a class="reference internal" href="#getting-packages-from-a-repository-that-supports-http-only" id="id24">5.3&nbsp;&nbsp;&nbsp;Getting packages from a repository that supports http only</a></li>
<li><a class="reference internal" href="#getting-packages-from-several-remotes-using-http-and-a-package-list" id="id25">5.4&nbsp;&nbsp;&nbsp;Getting packages from several remotes using http and a package list</a></li>
<li><a class="reference internal" href="#using-local-directories" id="id26">5.5&nbsp;&nbsp;&nbsp;Using local directories</a></li>
<li><a class="reference internal" href="#distmap" id="id27">5.6&nbsp;&nbsp;&nbsp;distmap</a></li>
</ul>
</li>
<li><a class="reference internal" href="#additions-directory" id="id28">6&nbsp;&nbsp;&nbsp;Additions Directory</a><ul class="auto-toc">
<li><a class="reference internal" href="#patching-ebuilds" id="id29">6.1&nbsp;&nbsp;&nbsp;Patching ebuilds</a></li>
<li><a class="reference internal" href="#importing-ebuilds" id="id30">6.2&nbsp;&nbsp;&nbsp;Importing ebuilds</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependency-rules" id="id31">7&nbsp;&nbsp;&nbsp;Dependency Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#simple-dependency-rules" id="id32">7.1&nbsp;&nbsp;&nbsp;Simple Dependency Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#rule-variants" id="id33">7.1.1&nbsp;&nbsp;&nbsp;Rule Variants</a></li>
<li><a class="reference internal" href="#rule-types" id="id34">7.1.2&nbsp;&nbsp;&nbsp;Rule types</a></li>
<li><a class="reference internal" href="#rule-file-examples" id="id35">7.1.3&nbsp;&nbsp;&nbsp;Rule File Examples</a></li>
<li><a class="reference internal" href="#rule-file-syntax" id="id36">7.1.4&nbsp;&nbsp;&nbsp;Rule File Syntax</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#package-rules" id="id37">8&nbsp;&nbsp;&nbsp;Package Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#package-rule-file-syntax" id="id38">8.1&nbsp;&nbsp;&nbsp;Package Rule File Syntax</a><ul class="auto-toc">
<li><a class="reference internal" href="#match-blocks" id="id39">8.1.1&nbsp;&nbsp;&nbsp;Match Blocks</a><ul class="auto-toc">
<li><a class="reference internal" href="#extended-match-block-syntax" id="id40">8.1.1.1&nbsp;&nbsp;&nbsp;Extended Match Block Syntax</a></li>
</ul>
</li>
<li><a class="reference internal" href="#action-blocks" id="id41">8.1.2&nbsp;&nbsp;&nbsp;Action Blocks</a><ul class="auto-toc">
<li><a class="reference internal" href="#extended-action-block-syntax" id="id42">8.1.2.1&nbsp;&nbsp;&nbsp;Extended Action Block Syntax</a></li>
</ul>
</li>
<li><a class="reference internal" href="#package-rule-examples" id="id43">8.1.3&nbsp;&nbsp;&nbsp;Package Rule Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#event-hooks" id="id44">9&nbsp;&nbsp;&nbsp;Event Hooks</a><ul class="auto-toc">
<li><a class="reference internal" href="#default-event-script" id="id45">9.1&nbsp;&nbsp;&nbsp;Default event script</a><ul class="auto-toc">
<li><a class="reference internal" href="#activating-a-hook-script" id="id46">9.1.1&nbsp;&nbsp;&nbsp;Activating a hook script</a></li>
<li><a class="reference internal" href="#adding-a-new-hook-script" id="id47">9.1.2&nbsp;&nbsp;&nbsp;Adding a new hook script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#event-policy" id="id48">9.2&nbsp;&nbsp;&nbsp;Event Policy</a></li>
<li><a class="reference internal" href="#hook-environment" id="id49">9.3&nbsp;&nbsp;&nbsp;Hook Environment</a></li>
<li><a class="reference internal" href="#adding-a-function-file" id="id50">9.4&nbsp;&nbsp;&nbsp;Adding a function file</a></li>
<li><a class="reference internal" href="#adding-a-hook-event" id="id51">9.5&nbsp;&nbsp;&nbsp;Adding a hook event</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-reference" id="id52">10&nbsp;&nbsp;&nbsp;Configuration Reference</a><ul class="auto-toc">
<li><a class="reference internal" href="#misc-options" id="id53">10.1&nbsp;&nbsp;&nbsp;misc options</a></li>
<li><a class="reference internal" href="#overlay-options" id="id54">10.2&nbsp;&nbsp;&nbsp;overlay options</a></li>
<li><a class="reference internal" href="#other-config-files" id="id55">10.3&nbsp;&nbsp;&nbsp;other config files</a></li>
<li><a class="reference internal" href="#shell-environment-hooks" id="id56">10.4&nbsp;&nbsp;&nbsp;shell environment / hooks</a></li>
<li><a class="reference internal" href="#logging" id="id57">10.5&nbsp;&nbsp;&nbsp;logging</a><ul class="auto-toc">
<li><a class="reference internal" href="#console-logging" id="id58">10.5.1&nbsp;&nbsp;&nbsp;console logging</a></li>
<li><a class="reference internal" href="#file-logging" id="id59">10.5.2&nbsp;&nbsp;&nbsp;file logging</a></li>
</ul>
</li>
<li><a class="reference internal" href="#options-for-debugging-manual-dependency-rule-creation-and-testing" id="id60">10.6&nbsp;&nbsp;&nbsp;options for debugging, manual dependency rule creation and testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3" id="id61">11&nbsp;&nbsp;&nbsp;Other config files</a><ul class="auto-toc">
<li><a class="reference internal" href="#use-expand-flag-rename-file" id="id62">11.1&nbsp;&nbsp;&nbsp;USE_EXPAND flag rename file</a></li>
<li><a class="reference internal" href="#field-definition-config" id="id63">11.2&nbsp;&nbsp;&nbsp;Field Definition Config</a><ul class="auto-toc">
<li><a class="reference internal" href="#example-the-default-field-definition-file" id="id64">11.2.1&nbsp;&nbsp;&nbsp;Example: The default field definition file</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dependency-resolution-console" id="id65">12&nbsp;&nbsp;&nbsp;Dependency Resolution Console</a></li>
<li><a class="reference internal" href="#implementation-overview" id="id66">13&nbsp;&nbsp;&nbsp;Implementation Overview</a><ul class="auto-toc">
<li><a class="reference internal" href="#packageinfo" id="id67">13.1&nbsp;&nbsp;&nbsp;PackageInfo</a></li>
<li><a class="reference internal" href="#repository-management" id="id68">13.2&nbsp;&nbsp;&nbsp;Repository Management</a><ul class="auto-toc">
<li><a class="reference internal" href="#repository" id="id69">13.2.1&nbsp;&nbsp;&nbsp;Repository</a><ul class="auto-toc">
<li><a class="reference internal" href="#adding-new-repository-types" id="id70">13.2.1.1&nbsp;&nbsp;&nbsp;Adding new repository types</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#overlay" id="id71">13.3&nbsp;&nbsp;&nbsp;Overlay</a><ul class="auto-toc">
<li><a class="reference internal" href="#metadata-creation" id="id72">13.3.1&nbsp;&nbsp;&nbsp;Metadata Creation</a></li>
<li><a class="reference internal" href="#manifest-creation" id="id73">13.3.2&nbsp;&nbsp;&nbsp;Manifest Creation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ebuild-creation" id="id74">13.4&nbsp;&nbsp;&nbsp;Ebuild Creation</a><ul class="auto-toc">
<li><a class="reference internal" href="#ebuild-variables" id="id75">13.4.1&nbsp;&nbsp;&nbsp;Ebuild Variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overlay-creation" id="id76">13.5&nbsp;&nbsp;&nbsp;Overlay Creation</a></li>
<li><a class="reference internal" href="#dependency-resolution" id="id77">13.6&nbsp;&nbsp;&nbsp;Dependency Resolution</a><ul class="auto-toc">
<li><a class="reference internal" href="#dependency-types" id="id78">13.6.1&nbsp;&nbsp;&nbsp;Dependency types</a><ul class="auto-toc">
<li><a class="reference internal" href="#description-file-dependency-fields" id="id79">13.6.1.1&nbsp;&nbsp;&nbsp;DESCRIPTION file dependency fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependency-environments" id="id80">13.6.2&nbsp;&nbsp;&nbsp;Dependency Environments</a></li>
<li><a class="reference internal" href="#ebuildjob-channel" id="id81">13.6.3&nbsp;&nbsp;&nbsp;EbuildJob Channel</a></li>
<li><a class="reference internal" href="#dependency-rule-pools" id="id82">13.6.4&nbsp;&nbsp;&nbsp;Dependency Rule Pools</a></li>
<li><a class="reference internal" href="#dependency-resolver-modules" id="id83">13.6.5&nbsp;&nbsp;&nbsp;Dependency Resolver Modules</a></li>
<li><a class="reference internal" href="#dependency-resolver" id="id84">13.6.6&nbsp;&nbsp;&nbsp;Dependency Resolver</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#contents">1&nbsp;&nbsp;&nbsp;Introduction</a></h1>
<p><em>roverlay</em> is an application that aims to provide integration of R packages
in Gentoo by creating a portage overlay for them.
Naturally, this also requires proper dependency resolution, especially on the
system level which cannot be done by <em>install.packages()</em> in R.</p>
<p>The project associated with <em>roverlay</em> is called
<em>Automatically generated overlay of R packages</em>, the initial work has been
done during the <em>Google Summer of Code 2012</em>.</p>
<p>At its current state, <em>roverlay</em> is capable of creating a complete overlay
with metadata and Manifest files by reading R packages.
It is also able to work incrementally, i.e. update an existing <em>R Overlay</em>.
Most aspects of overlay creation are configurable with text files.</p>
<p><em>roverlay</em> is written in python. A homepage is not available, only a
<a class="reference external" href="http://git.overlays.gentoo.org/gitweb/?p=proj/R_overlay.git;a=summary">git repository</a> that contains the source code.</p>
<p>This document is targeted at</p>
<blockquote>
<ul>
<li><p class="first">overlay maintainers who <strong>use roverlay</strong> to create the R Overlay</p>
<p>The most relevant chapters are <a class="reference internal" href="#installation">Installation</a> (2) and
<a class="reference internal" href="#running-roverlay">Running Roverlay</a> (3). Additionally, have a look at
<a class="reference internal" href="#basic-implementation-overview">Basic Implementation Overview</a> (4) if you want to know what <em>roverlay</em>
does and what to expect from the generated overlay.</p>
</li>
<li><p class="first"><em>roverlay</em> maintainers who <strong>control and test overlay creation</strong>,
e.g. configure which R packages will be part of the generated overlay</p>
<p>Depending on what you want to configure, chapters 5-10 are relevant,
namely <a class="reference internal" href="#repositories-getting-packages">Repositories / Getting Packages</a>, <cite>Additions Directory</cite>,
<a class="reference internal" href="#dependency-rules">Dependency Rules</a>, <a class="reference internal" href="#package-rules">Package Rules</a>, <a class="reference internal" href="#configuration-reference">Configuration Reference</a>
and <a class="reference internal" href="#field-definition-config">Field Definition Config</a>.</p>
<p>There is another chapter that is only interesting for testing, the
<a class="reference internal" href="#dependency-resolution-console">Dependency Resolution Console</a> (11), which can be used to interactively
test dependency rules.</p>
</li>
<li><p class="first"><em>roverlay</em> code maintainers who want to know <strong>how roverlay works</strong> for
code improvements etc.</p>
<p>The most important chapter is <a class="reference internal" href="#implementation-overview">Implementation Overview</a> (12) which has
references to other chapters (4-10) where required.</p>
</li>
</ul>
</blockquote>
<p>Expected prior knowlegde:</p>
<blockquote>
<ul class="simple">
<li>a few <em>R package</em> basics</li>
<li>portage basics, e.g. <em>Depend Atoms</em> and what an overlay is</li>
</ul>
</blockquote>
</div>
<div class="section" id="installation">
<h1><a class="toc-backref" href="#contents">2&nbsp;&nbsp;&nbsp;Installation</a></h1>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#contents">2.1&nbsp;&nbsp;&nbsp;Prerequisites</a></h2>
<ul>
<li><p class="first">python &gt;= 2.7 (tested with python 2.7 and 3.2)</p>
</li>
<li><p class="first">argparse (<a class="reference external" href="http://code.google.com/p/argparse">http://code.google.com/p/argparse</a>)</p>
</li>
<li><p class="first">rsync (for using rsync repositories)</p>
</li>
<li><p class="first">for Manifest creation:</p>
<ul class="simple">
<li>portage (<em>ebuild</em> and/or the <em>portage libs</em> directly)</li>
<li><em>true</em> or <em>echo</em> from coreutils or busybox for preventing
package downloads during Manifest creation (optional)</li>
</ul>
</li>
<li><p class="first">for generating documentation files: python docutils &gt;= 0.9</p>
</li>
<li><p class="first">hardware requirements (when using the default configuration):</p>
<blockquote>
<dl class="docutils">
<dt>disk</dt>
<dd><ul class="first last simple">
<li>50-55GB disk space for the R packages</li>
<li>a filesystem that supports symbolic or hard links</li>
<li>there will be many small-sized files (ebuilds),
so a filesystem with lots of inodes and a small block size
may be advantageous</li>
</ul>
</dd>
<dt>memory</dt>
<dd><p class="first last">up to 600MB which depends on the amount of processed packages and the
write mechanism in use. The amount can be halved (approximately) when
using a slower one.</p>
</dd>
<dt>time</dt>
<dd><p class="first last">Expect 3-6h execution time for the first run, depending on computing
and I/O speed. <em>roverlay</em> is able to work in incremental mode,
thus making subsequent runs need a lot less time.</p>
</dd>
</dl>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="via-emerge-gentoo">
<h2><a class="toc-backref" href="#contents">2.2&nbsp;&nbsp;&nbsp;via emerge (Gentoo)</a></h2>
<p>A live ebuild is available, <a class="reference external" href="http://git.overlays.gentoo.org/gitweb/?p=proj/R_overlay.git;a=blob;f=roverlay-9999.ebuild;hb=refs/heads/master">roverlay-9999.ebuild</a>.
Add it to your local overlay and run <tt class="docutils literal">emerge roverlay</tt>, which also installs
all necessary config files into <em>/etc/roverlay</em>.</p>
</div>
<div class="section" id="manual-installation">
<h2><a class="toc-backref" href="#contents">2.3&nbsp;&nbsp;&nbsp;Manual Installation</a></h2>
<p>After installing the dependencies as listed in <a class="reference internal" href="#prerequisites">Prerequisites</a>, clone the
<a class="reference external" href="http://git.overlays.gentoo.org/gitweb/?p=proj/R_overlay.git;a=summary">roverlay git repo</a> and then install <em>roverlay</em> and its python modules:</p>
<pre class="code sh literal-block">
git clone git://git.overlays.gentoo.org/proj/R_overlay.git

<span class="name builtin">cd </span>R_overlay <span class="operator">&amp;&amp;</span> make install
</pre>
<p><tt class="docutils literal">make install</tt> also accepts some variables, namely:</p>
<ul class="simple">
<li><em>DESTDIR</em></li>
<li><em>BINDIR</em>, defaults to <em>DESTDIR</em>/usr/local/bin</li>
<li><em>PYMOD_FILE_LIST</em>, which lists the installed python module files
and defaults to './roverlay_files.list'</li>
<li><em>PYTHON</em>, name or path of the python interpreter that is used to run
'setup.py', defaults to 'python'</li>
</ul>
<p><em>roverlay</em> can later be uninstalled with <tt class="docutils literal">make uninstall</tt>.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure to include <tt class="docutils literal"><span class="pre">--record</span> <span class="pre">&lt;somewhere&gt;/roverlay_files.list</span></tt>
when running <tt class="docutils literal">./setup.py install</tt> manually,
which can later be used to safely remove the python module files with
<tt class="docutils literal">xargs rm <span class="pre">-vrf</span> &lt; <span class="pre">&lt;somewhere&gt;/roverlay_files.list</span></tt>.
The <em>make</em> targets take care of this.</p>
</div>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">Support for this installation type is limited - no config files will be
installed!</p>
</div>
</div>
<div class="section" id="using-roverlay-without-installation">
<h2><a class="toc-backref" href="#contents">2.4&nbsp;&nbsp;&nbsp;Using <em>roverlay</em> without installation</a></h2>
<p>This is possible, too.
Make sure to meet the dependencies as listed in <a class="reference internal" href="#prerequisites">Prerequisites</a>.
Then, simply clone the git repository to a local directory that is referenced
as the <em>R Overlay src directory</em> from now on.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p>You have to <em>cd</em> into the <em>R Overlay src directory</em> before running
<em>roverlay</em> to ensure that the python modules can be imported correctly.</p>
<p>You can work around this by setting up a wrapper script:</p>
<pre class="code sh last literal-block">
<span class="comment">#!/bin/sh
# /usr/local/bin/roverlay.sh
# example wrapper script for roverlay
</span><span class="name builtin">cd</span> <span class="keyword">${</span><span class="name variable">ROVERLAY_SRC</span><span class="keyword">:-</span><span class="punctuation">~/roverlay/src</span><span class="keyword">}</span> <span class="operator">&amp;&amp;</span> ./roverlay.py <span class="literal string double">&quot;$&#64;&quot;</span>
</pre>
</div>
</div>
</div>
<div class="section" id="running-roverlay">
<h1><a class="toc-backref" href="#contents">3&nbsp;&nbsp;&nbsp;Running Roverlay</a></h1>
<div class="section" id="required-configuration-steps">
<h2><a class="toc-backref" href="#contents">3.1&nbsp;&nbsp;&nbsp;Required configuration steps</a></h2>
<p><em>roverlay</em> needs a configuration file to run.
If roverlay has been installed with <em>emerge</em>, it will look for the config file in
that order:</p>
<ol class="arabic simple">
<li><em>&lt;current directory&gt;/R-overlay.conf</em></li>
<li><em>~/roverlay/R-overlay.conf</em></li>
<li><em>/etc/roverlay/R-overlay.conf</em>,
which is part of the installation but has to be modified.</li>
</ol>
<p>Otherwise, <em>roverlay</em> will only look for <em>R-overlay.conf</em> in the current
directory. An example config file is available in the
<em>R Overlay src directory</em>.</p>
<p>The config file is a text file with '&lt;option&gt; = &lt;value&gt;' syntax. Some options
accept multiple values (e.g. &lt;option&gt; = file1, file2), in which case the
values have to be enclosed with quotes (-&gt; <tt class="docutils literal">&lt;option&gt; = &quot;file1 file2&quot;</tt>).</p>
<p>The following options should be set before running <em>roverlay</em>:</p>
<blockquote>
<dl class="docutils">
<dt>OVERLAY_DIR</dt>
<dd><p class="first">This sets the directory of the overlay that will be created.
This option is <strong>required</strong> and can be overridden on the command line
via <tt class="docutils literal"><span class="pre">--overlay</span> &lt;directory&gt;</tt>.</p>
<p class="last">Example: OVERLAY_DIR = ~/roverlay/overlay</p>
</dd>
<dt>DISTFILES</dt>
<dd><p class="first">This sets the root directory of all per-repo package directories.
This option is <strong>required</strong> and can be overridden on the command line
via <tt class="docutils literal"><span class="pre">--distroot</span> &lt;directory&gt;</tt>.</p>
<p class="last">Example: DISTFILES = ~/roverlay/distfiles</p>
</dd>
<dt>DISTDIR</dt>
<dd><p class="first">This sets the directory that contains symbolic or hard links to
all package files for which an ebuild could be created. It is used
for Manifest file creation and can serve as package mirror directory.</p>
<p class="last">Example: DISTDIR = ~/roverlay/distdir</p>
</dd>
<dt>LOG_FILE</dt>
<dd><p class="first">This sets the log file. An empty value disables file logging.</p>
<p class="last">Example: LOG_FILE = ~/roverlay/log/roverlay.log</p>
</dd>
<dt>LOG_LEVEL</dt>
<dd><p class="first">This sets the global log level, which is used for all log formats
without an own log level. Valid log levels are <tt class="docutils literal">DEBUG</tt>, <tt class="docutils literal">INFO</tt>,
<tt class="docutils literal">WARN</tt>/<tt class="docutils literal">WARNING</tt>, <tt class="docutils literal">ERROR</tt> and <tt class="docutils literal">CRITICAL</tt>.</p>
<p>Example: LOG_LEVEL = WARNING</p>
<div class="note last">
<p class="first admonition-title">Note</p>
<p class="last">Be careful with low log levels, especially <em>DEBUG</em>.
They produce a lot of messages that help to track ebuild creation of
the R packages, but increase the log file size dramatically.</p>
</div>
</dd>
<dt>LOG_LEVEL_CONSOLE</dt>
<dd><p class="first">This sets the console log level.</p>
<p class="last">Example: LOG_LEVEL_CONSOLE = INFO</p>
</dd>
<dt>LOG_LEVEL_FILE</dt>
<dd><p class="first">This sets the log level for file logging.</p>
<p class="last">Example: LOG_LEVEL_FILE = ERROR</p>
</dd>
</dl>
</blockquote>
<p>The following options should also be set (most of them are required), but
have reasonable defaults if <em>roverlay</em> has been installed using <em>emerge</em>:</p>
<blockquote>
<dl class="docutils">
<dt>SIMPLE_RULES_FILE</dt>
<dd><p class="first">This option lists dependency rule files and/or directories with
such files that should be used for dependency resolution.
Although not required, this option is <strong>recommended</strong> since ebuild
creation without dependency rules fails for most R packages.</p>
<p class="last">Example: SIMPLE_RULES_FILE = ~/roverlay/config/simple-deprules.d</p>
</dd>
<dt>REPO_CONFIG</dt>
<dd><p class="first">A list with one or more files that list repositories.
This option is <strong>required</strong> and can be overridden on the command line
via one or more <tt class="docutils literal"><span class="pre">--repo-config</span> &lt;file&gt;</tt> statements.</p>
<p class="last">Example: REPO_CONFIG = ~/roverlay/config/repo.list</p>
</dd>
<dt>PACKAGE_RULES</dt>
<dd><p class="first">A list of files and/or directories with package rules.
Package rules can be used to control overlay/ebuild creation.
This option is not required.</p>
<p class="last">Example: PACKAGE_RULES = ~/roverlay/config/packagerules.d</p>
</dd>
<dt>ADDITIONS_DIR</dt>
<dd><p class="first">Directory with an overlay-like structure that contains extra files, e.g.
ebuild patches and hand-written ebuilds.</p>
<p class="last">Example: ADDITIONS_DIR = ~/roverlay/additions</p>
</dd>
<dt>FIELD_DEFINITION</dt>
<dd><p class="first">The value of this option should point to a field definition file which
controls how an R package's DESCRIPTION file is read.
The file supplied by default should be fine.
This option is <strong>required</strong> and can be overridden on the command line
via <tt class="docutils literal"><span class="pre">--field-definition</span> &lt;file&gt;</tt>.</p>
<p class="last">Example: FIELD_DEFINITION = ~/roverlay/config/description_fields.conf</p>
</dd>
<dt>USE_EXPAND_DESC</dt>
<dd><p class="first">A file that contains USE_EXPAND flag descriptions. This option is not
required.</p>
<p class="last">Example: USE_EXPAND_DESC = ~/roverlay/config/useflag/useflag_desc</p>
</dd>
<dt>USE_EXPAND_RENAME</dt>
<dd><p class="first">The value of this option should point to a USE flag remap file which
can be used to rename USE_EXPAND flags. This option is not required.</p>
<p class="last">Example: USE_EXPAND_RENAME = ~/roverlay/config/useflag_rename</p>
</dd>
<dt>CACHEDIR</dt>
<dd><p class="first">Directory for generated files that do not belong to the overlay, e.g.
the <em>distmap</em> file. This option is <strong>required</strong>.</p>
<p class="last">Example: CACHEDIR = ~/roverlay/workdir/cache</p>
</dd>
<dt>OVERLAY_ECLASS</dt>
<dd><p class="first">This option lists eclass files that should be imported into the overlay
(into <em>OVERLAY_DIR</em>/eclass/) and inherited in all ebuilds.
Specifying an eclass file that implements the ebuild phase functions
(e.g. <em>src_install()</em>) is highly <strong>recommended</strong>. A default file
named <em>R-packages.eclass</em> should be part of your installation.</p>
<p class="last">Example: OVERLAY_ECLASS = ~/roverlay/eclass/R-packages.eclass</p>
</dd>
<dt>DISTDIR_STRATEGY</dt>
<dd><p class="first">A list of methods that define how to create the DISTDIR. The methods
will be tried in the specified order, until the first one succeeds.
The available methods are <em>symlink</em>, <em>hardlink</em>, <em>copy</em> and <em>tmpdir</em>.
This option is <strong>required</strong>.</p>
<p>Example: DISTDIR_STRATEGY = &quot;hardlink symlink&quot;</p>
<p class="last">Try hard links first, then fall back to symbolic ones. This is the
default value for this option.</p>
</dd>
<dt>DISTDIR_FLAT</dt>
<dd><p class="first">This option controls whether DISTDIR will contain per-package
subdirectories with links to the package files (&quot;not flat&quot;) or all
links/files in a single directory (&quot;flat&quot;). This option is ignored
if DISTDIR_STRATEGY is <em>tmpdir</em>.
Leaving this option as-is (<em>enabled</em>) is recommended if you want to use
DISTDIR as package mirror.</p>
<p class="last">Example: DISTDIR_FLAT = yes</p>
</dd>
</dl>
</blockquote>
<p>There is another option that is useful for creating new dependency rules,
<a class="reference internal" href="#log-file-unresolvable">LOG_FILE_UNRESOLVABLE</a>, which will write all unresolvable dependencies
to the specified file (one dependency string per line).</p>
<div class="section" id="extended-configuration-where-to-go-from-here">
<h3><a class="toc-backref" href="#contents">3.1.1&nbsp;&nbsp;&nbsp;Extended Configuration / Where to go from here?</a></h3>
<p>Proceed with <a class="reference internal" href="#running-it">Running it</a> if the default configuration and the changes already
made are fine, otherwise the following chapters are relevant and should
provide you with the knowledge to determine the ideal configuration.</p>
<dl class="docutils">
<dt>Repositories</dt>
<dd>See <a class="reference internal" href="#repositories-getting-packages">Repositories / Getting Packages</a>, which describes how repositories
can be configured.</dd>
<dt>Dependency Rules</dt>
<dd>See <a class="reference internal" href="#dependency-rules">Dependency Rules</a>, which explains the dependency rule syntax amd how
they work.</dd>
<dt>Package Rules</dt>
<dd>See <a class="reference internal" href="#package-rules">Package Rules</a>, which explains how to control <em>ebuild creation</em>.</dd>
<dt>Main Config</dt>
<dd>See <a class="reference internal" href="#configuration-reference">Configuration Reference</a> for all main config options like log file
rotation and assistance for writing new <em>dependency rules</em>.</dd>
<dt>Field Definition</dt>
<dd>Refer to <a class="reference internal" href="#id4">Field Definition</a> in case you want to change <em>how</em> R packages
are being read, e.g. if you want the 'Depents' information field (obviously
a typo) to be understood as 'Depends'.</dd>
</dl>
</div>
</div>
<div class="section" id="running-it">
<h2><a class="toc-backref" href="#contents">3.2&nbsp;&nbsp;&nbsp;Running it</a></h2>
<p>If <em>roverlay</em> has been installed, you can run it with <tt class="docutils literal">roverlay</tt>, otherwise
cd into the <em>R overlay src directory</em> and run <tt class="docutils literal">./roverlay.py</tt>.</p>
<p>In any case, the basic <em>roverlay</em> script usage is</p>
<pre class="code literal-block">
roverlay --config &lt;config file&gt; [&lt;options&gt;] [&lt;commands&gt;]
</pre>
<p>or</p>
<pre class="code literal-block">
roverlay [&lt;options&gt;] [&lt;commands&gt;]
</pre>
<p>which will search for the config file as described in
<a class="reference internal" href="#required-configuration-steps">Required configuration steps</a>. The default command is <em>create</em>, which
downloads the R packages (unless explicitly forbidden to do so) and generates
the overlay. This is the desired behavior in most cases, so simply running
<tt class="docutils literal">roverlay</tt> should be fine. See <a class="reference internal" href="#basic-implementation-overview">Basic Implementation Overview</a> if you want
to know in detail what <em>roverlay</em> does before running it.</p>
<p><em>roverlay</em> also accepts some <strong>options</strong>, most notably:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--nosync</span>, <span class="option">--no-sync</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Disable downloading of R packages.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--distmap-verify</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Enforce verification of R packages in the package mirror directory.
This also tries to recreate the distmap.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--no-incremental</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Force recreation of existing ebuilds</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--immediate-ebuild-writes</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td><p class="first">Immediately write ebuilds when they are ready.</p>
<p>The default behavior is to wait for all ebuilds and then write them using
ebuild write threads. The latter one is faster, but consumes more memory
since ebuilds must be kept until all packages have been processed.
Test results show that memory consumption increases by factor 2 when using
the faster write mechanism (at ca. 95% ebuild creation success rate),
&lt;&lt;while ebuild write time decreases by ???&gt;&gt;.</p>
<p class="last">Summary: Expect 300 (slow) or 600MB (fast) memory consumption when using
the default package repositories.</p>
</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--fixup-category-move</span>, <span class="option">--fixup-category-move-reverse</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Remove ebuilds that have been moved to a different category.
See <a class="reference internal" href="#action-blocks">Action Blocks</a> in <a class="reference internal" href="#package-rules">Package Rules</a> for details.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--config <var>file</var></span>, <span class="option">-c <var>file</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Path to the config file</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--help</span>, <span class="option">-h</span></kbd></td>
<td>Show all options</td></tr>
</tbody>
</table>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last"><em>--no-incremental</em> does not delete an existing overlay, it merely ignores
and, potentially, overwrites existing ebuilds.
Use <em>rm -rf &lt;overlay&gt;</em> to do that.</p>
</div>
<p>For <strong>testing</strong> <em>roverlay</em>, these <strong>options</strong> may be convenient:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">--no-manifest</span></kbd></td>
<td><p class="first">Skip Manifest file creation.</p>
<p class="last">This saves a considerable amount of time
(&gt;100min when using the default package repositories) at the expense of
an overlay that is not suitable for production usage.</p>
</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--no-write</span></kbd></td>
<td>Disable overlay writing</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--show</span></kbd></td>
<td>Print all ebuilds and metadata to console</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--repo-config <var>file</var></span>, <span class="option">-R <var>file</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Repo config file to use. Can be specified more than once.
This disables all repo files configured in the main config file.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--local-distdir <var>directory</var></span>, <span class="option">--from <var>directory</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Create an overlay using the packages found in <em>directory</em>. This disables
all other repositories. The <em>SRC_URI</em> ebuild variable will be invalid!</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--print-package-rules</span>, <span class="option">--ppr</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Print package rules to stdout after parsing them and exit.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--overlay <var>directory</var></span>, <span class="option">-O <var>directory</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Create the overlay at the given position.</td></tr>
</tbody>
</table>
<p>For reference, these <strong>commands</strong> are accepted by <em>roverlay</em>:</p>
<dl class="docutils">
<dt>create</dt>
<dd>As described above, this will run ebuild, metadata creation, including
overlay and Manifest file writing.
This command implies the <strong>sync</strong> command unless the <em>--nosync</em> option
is specified.</dd>
<dt>sync</dt>
<dd>This will download all packages from the configured remotes.</dd>
<dt>depres_console, depres</dt>
<dd><p class="first">Starts an interactive dependency resolution console that supports rule
creation/deletion, loading rules from files, writing rules to files
and resolving dependencies.</p>
<p>Meant for <strong>testing only</strong>.</p>
<p class="last">More information can be found in the <a class="reference internal" href="#depres-console">DepRes Console</a> section.</p>
</dd>
<dt>apply_rules</dt>
<dd><p class="first">Applies the package rules to all available packages and reports what has
been done, either to stdout or to <tt class="docutils literal"><span class="pre">--dump-file</span> &lt;file&gt;</tt>.</p>
<p>Meant for testing.</p>
<p class="last">This command implies the <strong>sync</strong> command unless the <em>--nosync</em> option
is specified.</p>
</dd>
</dl>
</div>
<div class="section" id="providing-a-package-mirror">
<h2><a class="toc-backref" href="#contents">3.3&nbsp;&nbsp;&nbsp;Providing a package mirror</a></h2>
<p><a class="reference internal" href="#distdir">DISTDIR</a> with a non-temporary strategy can be used to create a directory
containing all package files (as symbolic/hard links or as files).
You have to set up a <em>data service</em>, e.g. an http server, that makes this
directory accessible.</p>
<p>The default configuration will create hard links to all package files for
which an ebuild could be created in a single directory. It will fall back
to symbolic links if hard links are not supported. This should be fine in
most cases, but fine-tuning can be done via <a class="reference internal" href="#overlay-distdir-strategy">OVERLAY_DISTDIR_STRATEGY</a> and
<a class="reference internal" href="#overlay-distdir-flat">OVERLAY_DISTDIR_FLAT</a>.</p>
</div>
</div>
<div class="section" id="basic-implementation-overview">
<h1><a class="toc-backref" href="#contents">4&nbsp;&nbsp;&nbsp;Basic Implementation Overview</a></h1>
<div class="section" id="how-roverlay-works">
<h2><a class="toc-backref" href="#contents">4.1&nbsp;&nbsp;&nbsp;How <em>roverlay</em> works</a></h2>
<p>These are the steps that <em>roverlay</em> performs:</p>
<ol class="arabic">
<li><p class="first"><strong>sync</strong> - get R packages using various methods
(rsync, http, local directory)</p>
</li>
<li><p class="first">scan the R Overlay directory (if it exists) for valid ebuilds</p>
</li>
<li><p class="first">import ebuilds from the additions dir</p>
</li>
<li><p class="first"><strong>add</strong> - queue all R packages for ebuild creation</p>
<ul>
<li><p class="first">all repositories are asked to list their packages which are then added
to a queue</p>
</li>
<li><p class="first">packages may be declined by the overlay creator if they already have
an ebuild</p>
</li>
<li><p class="first">packages may be declined or manipulated by package rules</p>
<p>See also: <a class="reference internal" href="#package-rules">Package Rules</a></p>
</li>
</ul>
</li>
<li><p class="first"><strong>create</strong> - process each package <em>p</em> from the package queue
(thread-able on a per package basis)</p>
</li>
</ol>
<blockquote>
<ul>
<li><p class="first">read <em>p</em>'s DESCRIPTION file that contains information fields
like 'Depends', 'Description' and 'Suggests'</p>
</li>
<li><p class="first">resolve <em>p</em>'s dependencies</p>
<ul>
<li><p class="first">differentiate between <em>required</em> and <em>optional</em> dependencies
(for example, dependencies from the 'Depends' field are required,
while those from 'Suggests' are optional)</p>
</li>
<li><p class="first"><strong>immediately stop</strong> processing <em>p</em> if a <em>required</em> dependency
cannot be resolved in which case a valid ebuild cannot be created</p>
<p>See also: <a class="reference internal" href="#dependency-resolution">Dependency Resolution</a></p>
</li>
</ul>
</li>
<li><p class="first">create an ebuild for <em>p</em> by using the dependency resolution results
and a few information fields like 'Description'</p>
</li>
<li><p class="first"><strong>done</strong> with <em>p</em> - the overlay creator takes control over <em>p</em>
and may decide to write <em>p</em>'s ebuild now (or later)</p>
</li>
</ul>
</blockquote>
<ol class="arabic simple" start="6">
<li>write the overlay<ul>
<li>write/update the profiles dir<ul>
<li><em>roverlay</em> respects manual changes to USE_EXPAND description files</li>
</ul>
</li>
<li>write all ebuilds and apply patches to them
(supports threads on a per package basis)</li>
<li>write the <em>metadata.xml</em> files
(supports threads on a per package basis)<ul>
<li>this uses the latest created ebuild available for a package</li>
</ul>
</li>
<li>write the <em>Manifest</em> files
(does not support threads by default / supports threads on a per package
basis when using <em>portage</em> directly)<ul>
<li>this uses all ebuilds availabe for a package</li>
</ul>
</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="expected-overlay-result-structure-of-the-generated-overlay">
<h2><a class="toc-backref" href="#contents">4.2&nbsp;&nbsp;&nbsp;Expected Overlay Result / Structure of the generated overlay</a></h2>
<p>Assuming that the default configuration (where possible) and the <em>R-packages</em>
eclass file are used, the result should look like:</p>
<pre class="code text literal-block">
&lt;overlay root&gt;/
&lt;overlay root&gt;/eclass
&lt;overlay root&gt;/eclass/R-packages.eclass
&lt;overlay root&gt;/profiles
&lt;overlay root&gt;/profiles/categories
&lt;overlay root&gt;/profiles/repo_name
&lt;overlay root&gt;/profiles/use.desc
&lt;overlay root&gt;/profiles/desc
&lt;overlay root&gt;/profiles/desc/r_suggests.desc
&lt;overlay root&gt;/sci-R/&lt;many directories per R package&gt;
&lt;overlay root&gt;/sci-R/seewave/
&lt;overlay root&gt;/sci-R/seewave/Manifest
&lt;overlay root&gt;/sci-R/seewave/metadata.xml
&lt;overlay root&gt;/sci-R/seewave/seewave-1.5.9.ebuild
&lt;overlay root&gt;/sci-R/seewave/seewave-1.6.4.ebuild
</pre>
<div class="section" id="expected-ebuild-result">
<h3><a class="toc-backref" href="#contents">4.2.1&nbsp;&nbsp;&nbsp;Expected Ebuild Result</a></h3>
<dl class="docutils">
<dt>Ebuild Template</dt>
<dd><pre class="code text first literal-block">
&lt;ebuild header&gt;

EAPI=&lt;EAPI&gt;

inherit &lt;eclass(es)&gt;

DESCRIPTION=&quot;&lt;the R package's description&gt;&quot;
SRC_URI=&quot;&lt;src uri for the R package&gt;&quot;

IUSE=&quot;${IUSE-}
   r_suggests_&lt;flag&gt; r_suggests_&lt;another flag&gt; ...
&quot;
R_SUGGESTS=&quot;r_suggests_&lt;flag&gt;? ( &lt;optional dependency&gt; ) ...&quot;
DEPEND=&quot;&lt;build time dependencies for the R package&gt;&quot;
RDEPEND=&quot;${DEPEND-}
   &lt;runtime dependencies&gt;
   ${R_SUGGESTS-}
&quot;

_UNRESOLVED_PACKAGES=(&lt;unresolvable, but optional dependencies&gt;)
</pre>
<p>Some of the variables may be missing if they are not needed.</p>
<p>A really minimal ebuild would look like:</p>
<pre class="code text last literal-block">
&lt;ebuild header&gt;

EAPI=&lt;EAPI&gt;

inherit &lt;eclass(es)&gt;

SRC_URI=&quot;&lt;src uri for the R package&gt;&quot;
</pre>
</dd>
<dt>Example: seewave 1.6.4 from CRAN:</dt>
<dd><p class="first">The default ebuild header (which cannot be changed) automatically sets
the ebuild's copyright year to 1999-<em>&lt;current year&gt;</em>.</p>
<pre class="code sh last literal-block">
<span class="comment"># Copyright 1999-2013 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $
</span>
<span class="name variable">EAPI</span><span class="operator">=</span>4
inherit R-packages

<span class="name variable">DESCRIPTION</span><span class="operator">=</span><span class="literal string double">&quot;Time wave analysis and graphical representation&quot;</span>
<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;http://cran.r-project.org/src/contrib/seewave_1.6.4.tar.gz&quot;</span>

<span class="name variable">IUSE</span><span class="operator">=</span><span class="literal string double">&quot;${IUSE-}
   r_suggests_sound
   r_suggests_audio
&quot;</span>
<span class="name variable">R_SUGGESTS</span><span class="operator">=</span><span class="literal string double">&quot;
   r_suggests_sound? ( sci-R/sound )
   r_suggests_audio? ( sci-R/audio )
&quot;</span>
<span class="name variable">DEPEND</span><span class="operator">=</span><span class="literal string double">&quot;sci-R/fftw
   sci-R/tuneR
   &gt;=dev-lang/R-2.15.0
   sci-R/rpanel
   sci-R/rgl
&quot;</span>
<span class="name variable">RDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;${DEPEND-}
   media-libs/flac
   sci-libs/fftw
   media-libs/libsndfile
   ${R_SUGGESTS-}
&quot;</span>
</pre>
</dd>
<dt>Example: MetaPCA 0.1.3 from CRAN's archive:</dt>
<dd><p class="first">Note the shortened <em>DESCRIPTION</em> variable that points to the <em>metadata.xml</em>
file. This happens if the description is too long.</p>
<pre class="code sh last literal-block">
<span class="comment"># Copyright 1999-2013 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $
</span>
<span class="name variable">EAPI</span><span class="operator">=</span>4
inherit R-packages

<span class="name variable">DESCRIPTION</span><span class="operator">=</span><span class="literal string double">&quot;MetaPCA: Meta-analysis in the Di... (see metadata)&quot;</span>
<span class="name variable">SRC_URI</span><span class="operator">=</span><span class="literal string double">&quot;http://cran.r-project.org/src/contrib/Archive/MetaPCA/MetaPCA_0.1.3.tar.gz&quot;</span>

<span class="name variable">IUSE</span><span class="operator">=</span><span class="literal string double">&quot;${IUSE-}
   r_suggests_domc
   r_suggests_affy
   r_suggests_ellipse
   r_suggests_pcapp
   r_suggests_mass
   r_suggests_impute
   r_suggests_dosmp
   r_suggests_geoquery
&quot;</span>
<span class="name variable">R_SUGGESTS</span><span class="operator">=</span><span class="literal string double">&quot;
   r_suggests_domc? ( sci-R/doMC )
   r_suggests_affy? ( sci-R/affy )
   r_suggests_ellipse? ( sci-R/ellipse )
   r_suggests_pcapp? ( sci-R/pcaPP )
   r_suggests_mass? ( sci-R/MASS )
   r_suggests_impute? ( sci-R/impute )
   r_suggests_dosmp? ( sci-R/doSMP )
   r_suggests_geoquery? ( sci-R/GEOquery )
&quot;</span>
<span class="name variable">DEPEND</span><span class="operator">=</span><span class="literal string double">&quot;sci-R/foreach&quot;</span>
<span class="name variable">RDEPEND</span><span class="operator">=</span><span class="literal string double">&quot;${DEPEND-}
   ${R_SUGGESTS-}
&quot;</span>

<span class="name variable">_UNRESOLVED_PACKAGES</span><span class="operator">=(</span><span class="literal string single">'hgu133plus2.db'</span><span class="operator">)</span>
</pre>
</dd>
</dl>
</div>
<div class="section" id="expected-metadata-xml-result">
<h3><a class="toc-backref" href="#contents">4.2.2&nbsp;&nbsp;&nbsp;Expected <em>metadata.xml</em> Result</a></h3>
<p>The <em>metadata.xml</em> will contain the full description for the latest version
of a package.</p>
<dl class="docutils">
<dt>Example: seewave from CRAN</dt>
<dd><p class="first">Note the ' // ' delimiter. It will be used to separate description strings
if a package has more than one, e.g. one in its <em>Title</em> and one in its
<em>Description</em> information field.</p>
<pre class="code xml last literal-block">
<span class="comment preproc">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="comment preproc">&lt;!DOCTYPE pkgmetadata SYSTEM &quot;http://www.gentoo.org/dtd/metadata.dtd&quot;&gt;</span>
<span class="name tag">&lt;pkgmetadata&gt;</span>
   <span class="name tag">&lt;longdescription&gt;</span>
      Time wave analysis and graphical representation // seewave
      provides functions for analysing, manipulating, displaying,
      editing and synthesizing time waves (particularly sound).  This
      package processes time analysis (oscillograms and envelopes),
      spectral content, resonance quality factor, entropy, cross
      correlation and autocorrelation, zero-crossing, dominant
      frequency, analytic signal, frequency coherence, 2D and 3D
      spectrograms and many other analyses.
   <span class="name tag">&lt;/longdescription&gt;</span>
<span class="name tag">&lt;/pkgmetadata&gt;</span>
</pre>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="repositories-getting-packages">
<span id="repositories"></span><h1><a class="toc-backref" href="#contents">5&nbsp;&nbsp;&nbsp;Repositories / Getting Packages</a></h1>
<p><em>roverlay</em> is capable of downloading R packages via rsync and http,
and is able to use any packages locally available. The method used to get and
use the packages is determined by the concrete <strong>type of a repository</strong>,
which is the topic of this section. It also covers repository configuration.</p>
<div class="section" id="a-word-about-repo-config-files">
<span id="repo-config"></span><h2><a class="toc-backref" href="#contents">5.1&nbsp;&nbsp;&nbsp;A word about repo config files</a></h2>
<p>Repo config files use <a class="reference external" href="http://docs.python.org/library/configparser.html">ConfigParser</a> syntax (known from ini files).</p>
<p>Each repo entry section is introduced with <tt class="docutils literal">[&lt;repo name&gt;]</tt> and defines</p>
<ul class="simple">
<li>how <em>roverlay</em> can download the R packages from a repo
and where they should be stored</li>
<li>how ebuilds can download the packages (-&gt; <em>SRC_URI</em>)</li>
<li>repo type specific options, e.g. whether the repo supports package file
verification</li>
</ul>
<p>Such options are declared with <tt class="docutils literal">&lt;option&gt; = &lt;value&gt;</tt> in the repo entry.</p>
<p id="repo-config-options">The common options for repository entries are:</p>
<ul>
<li><p class="first"><em>type</em> (optional), which declares the repository type.
Available types are:</p>
<ul class="simple">
<li><a class="reference internal" href="#rsync">rsync</a></li>
<li><a class="reference internal" href="#websync-repo">websync_repo</a></li>
<li><a class="reference internal" href="#websync-pkglist">websync_pkglist</a></li>
<li><a class="reference internal" href="#local">local</a></li>
</ul>
<p>Defaults to <em>rsync</em>.</p>
</li>
<li><p class="first"><em>src_uri</em> (<strong>required</strong>),
which declares how ebuilds can download the packages.
Some repo types use this for downloading, too.</p>
</li>
<li><p class="first"><em>directory</em> (optional),
which explicitly sets the package directory to use.
The default behavior is to use <a class="reference internal" href="#distfiles-root">DISTFILES_ROOT</a>/&lt;repo name&gt;</p>
</li>
</ul>
<div class="hint">
<p class="first admonition-title">Hint</p>
<p class="last">Repo names are allowed contain slashes, which will be respected when
creating the default directory.</p>
</div>
</div>
<div class="section" id="rsync-repos">
<span id="rsync"></span><h2><a class="toc-backref" href="#contents">5.2&nbsp;&nbsp;&nbsp;Rsync repos</a></h2>
<p>Runs <em>rsync</em> to download packages. Automatic sync retries are supported if
<em>rsync</em>'s exit code indicates chances of success.
For example, up to 3 retries are granted if <em>rsync</em> returns
<em>Partial transfer due to vanished source files</em> which likely happens when
syncing big repositories like CRAN.</p>
<p>This repo type extends the default options by:</p>
<ul class="simple">
<li><em>rsync_uri</em> (<strong>required</strong>), which specifies the uri used for syncing</li>
<li><em>recursive</em> (optional), which passes <tt class="docutils literal"><span class="pre">--recursive</span></tt> to <em>rsync</em> if set to
'yes'</li>
<li><em>extra_rsync_opts</em> (optional), which passes arbitrary options to <em>rsync</em>.
This can be used include/exclude files or to show progress during transfer.
Options with whitespace are not supported.</li>
</ul>
<p>Examples:</p>
<ul>
<li><p class="first">CRAN</p>
<blockquote>
<pre class="code ini literal-block">
<span class="keyword">[CRAN]</span>
<span class="name attribute">type</span>             <span class="operator">=</span> <span class="literal string">rsync</span>
<span class="name attribute">rsync_uri</span>        <span class="operator">=</span> <span class="literal string">cran.r-project.org::CRAN/src/contrib</span>
<span class="name attribute">src_uri</span>          <span class="operator">=</span> <span class="literal string">http://cran.r-project.org/src/contrib</span>
<span class="name attribute">extra_rsync_opts</span> <span class="operator">=</span> <span class="literal string">--progress --exclude=PACKAGES --exclude=PACKAGES.gz</span>
</pre>
</blockquote>
</li>
<li><p class="first">CRAN's archive:</p>
<blockquote>
<pre class="code ini literal-block">
<span class="keyword">[CRAN-Archive]</span>
<span class="name attribute">type</span>             <span class="operator">=</span> <span class="literal string">rsync</span>
<span class="name attribute">rsync_uri</span>        <span class="operator">=</span> <span class="literal string">cran.r-project.org::CRAN/src/contrib/Archive</span>
<span class="name attribute">src_uri</span>          <span class="operator">=</span> <span class="literal string">http://cran.r-project.org/src/contrib/Archive</span>
<span class="name attribute">extra_rsync_opts</span> <span class="operator">=</span> <span class="literal string">--progress</span>
<span class="name attribute">recursive</span>        <span class="operator">=</span> <span class="literal string">yes</span>
</pre>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="getting-packages-from-a-repository-that-supports-http-only">
<span id="websync-repo"></span><h2><a class="toc-backref" href="#contents">5.3&nbsp;&nbsp;&nbsp;Getting packages from a repository that supports http only</a></h2>
<p>This is your best bet if the remote is a repository but does not offer rsync
access. Basic digest verification is supported (MD5). The remote has to have
a package list file, typically named <em>PACKAGES</em>,
with a special syntax (debian control file syntax).</p>
<p>A package list example,
excerpt from <a class="reference external" href="http://www.omegahat.org/R/src/contrib/PACKAGES">omegahat's PACKAGES file</a> (as of Aug 2012):</p>
<pre class="code control literal-block">
<span class="error">...</span>
<span class="keyword">Package</span><span class="whitespace">: </span><span class="literal string">CGIwithR</span>
<span class="keyword">Version</span>: <span class="literal number">0.73-0</span>
<span class="keyword">Suggests</span><span class="whitespace">: </span><span class="literal string">GDD</span>
<span class="keyword">License</span><span class="whitespace">: </span><span class="literal string">GPL (&gt;= 2)</span>
<span class="keyword">MD5sum</span><span class="whitespace">: </span><span class="literal string">50b1f48209c9e66909c7afb3a4b8af5e</span>

<span class="keyword">Package</span><span class="whitespace">: </span><span class="literal string">CodeDepends</span>
<span class="keyword">Version</span>: <span class="literal number">0.2-1</span>
<span class="keyword">Depends</span>: <span class="name function">methods</span>
<span class="keyword">Imports</span><span class="whitespace">: </span><span class="literal string">codetools, XML</span>
<span class="keyword">Suggests</span><span class="whitespace">: </span><span class="literal string">graph, Rgraphviz</span>
<span class="keyword">License</span><span class="whitespace">: </span><span class="literal string">GPL</span>
<span class="keyword">MD5sum</span><span class="whitespace">: </span><span class="literal string">e2ec3505f9db1a96919a72f07673a2d8</span>
<span class="error">...</span>
</pre>
<p>An example repo config entry for omegahat:</p>
<pre class="code ini literal-block">
<span class="keyword">[omegahat]</span>
<span class="name attribute">type</span>    <span class="operator">=</span> <span class="literal string">websync_repo</span>
<span class="name attribute">src_uri</span> <span class="operator">=</span> <span class="literal string">http://www.omegahat.org/R/src/contrib</span>
<span class="name attribute">digest</span>  <span class="operator">=</span> <span class="literal string">md5</span>
<span class="comment">#digest = none</span>
</pre>
<p>This repo type extends the default options by:</p>
<ul class="simple">
<li><em>digest</em>, which declares that the remote supports digest based package file
verification. Accepted values are 'md5' and 'none'. Defaults to 'none',
which disables verification.</li>
<li><em>pkglist_file</em>, which sets the name of the package list file and defaults
to PACKAGES</li>
<li><em>pkglist_uri</em>, which explicitly sets the uri of the package list file.
Defaults to <em>src_uri</em>/<em>pkglist_file</em></li>
</ul>
<p>None of these options are required.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The content type of the remote's package list file has to be exactly
<em>text/plain</em>, compressed files are not supported.</p>
</div>
</div>
<div class="section" id="getting-packages-from-several-remotes-using-http-and-a-package-list">
<span id="websync-pkglist"></span><h2><a class="toc-backref" href="#contents">5.4&nbsp;&nbsp;&nbsp;Getting packages from several remotes using http and a package list</a></h2>
<p>This is not a real repository type, instead it creates a <em>local</em> repository
by downloading single R packages from different remotes.
Its only requirement is that a package is downloadable via http.
Apart from an entry in the repo config file, it also needs a file that lists
one package uri per line:</p>
<pre class="code text literal-block">
...
http://cran.r-project.org/src/contrib/seewave_1.6.4.tar.gz
http://download.r-forge.r-project.org/src/contrib/zoo_1.7-7.tar.gz
http://www.omegahat.org/R/src/contrib/Aspell_0.2-0.tar.gz
...
</pre>
<p>Comments are not supported. Assuming that such a package list exists at
<em>~/roverlay/config/http_packages.list</em>, an example entry in the repo config
file would be:</p>
<pre class="code ini literal-block">
<span class="keyword">[http-packages]</span>
<span class="name attribute">type</span>    <span class="operator">=</span> <span class="literal string">websync_pkglist</span>
<span class="name attribute">pkglist</span> <span class="operator">=</span> <span class="literal string">~/roverlay/config/http_packages.list</span>
</pre>
<p>This repo type extends the default options by:</p>
<ul class="simple">
<li><em>pkglist</em>, which sets the package list file. This option is <strong>required</strong>.</li>
</ul>
</div>
<div class="section" id="using-local-directories">
<span id="local"></span><h2><a class="toc-backref" href="#contents">5.5&nbsp;&nbsp;&nbsp;Using local directories</a></h2>
<p>Using local package directories is possible, too.</p>
<p>Example:</p>
<pre class="code ini literal-block">
<span class="keyword">[local-packages]</span>
<span class="name attribute">type</span>      <span class="operator">=</span> <span class="literal string">local</span>
<span class="name attribute">directory</span> <span class="operator">=</span> <span class="literal string">/var/local/R-packages</span>
<span class="name attribute">src_uri</span>   <span class="operator">=</span> <span class="literal string">http://localhost/R-packages</span>
</pre>
<p>This will use all packages from <em>/var/local/R-packages</em> and assumes
that they are available via <em>http://localhost/R-packages</em>.</p>
<p>A local directory will never be modified.</p>
<div class="important">
<p class="first admonition-title">Important</p>
<p class="last">Using this repo type is <strong>not recommended for production usage</strong> because
the <em>SRC_URI</em> variable in created ebuilds will be invalid unless you have
downloaded all packages from the same remote in which case you should
consider using one of the <strong>websync</strong> repo types, <a class="reference internal" href="#websync-repo">websync_repo</a> and
<a class="reference internal" href="#websync-pkglist">websync_pkglist</a>.</p>
</div>
</div>
<div class="section" id="distmap">
<h2><a class="toc-backref" href="#contents">5.6&nbsp;&nbsp;&nbsp;distmap</a></h2>
<p><em>roverlay</em> uses a text file to store information about files in the package
mirror directory (<a class="reference internal" href="#overlay-distdir-root">OVERLAY_DISTDIR_ROOT</a>). This is necessary for comparing
package files from repos with files for which an ebuild has already been
created (in previous runs).</p>
<p>With the help of the <em>distmap file</em>, <em>roverlay</em> is able to determine whether
upstream has changed a package file silently and creates a revision-bumped
ebuild for the <em>new</em> package file.</p>
<p>The <em>distmap file</em> can optionally be compressed (bzip2 or gzip), which
reduces its size considerably.</p>
</div>
</div>
<div class="section" id="additions-directory">
<h1><a class="toc-backref" href="#contents">6&nbsp;&nbsp;&nbsp;Additions Directory</a></h1>
<p>The <em>additions directory</em> is a directory with overlay-like structure that
contains extra files for overlay creation. Currently, ebuild patches and
ebuild files are supported.</p>
<p>To give an idea of how this directory could</p>
<div class="section" id="patching-ebuilds">
<h2><a class="toc-backref" href="#contents">6.1&nbsp;&nbsp;&nbsp;Patching ebuilds</a></h2>
<p>Patches can apply to a <strong>specific version</strong> or to <strong>all versions</strong> of a
package.</p>
<p>The naming convention for patches is (full filesystem paths relative to the
additions dir):</p>
<pre class="code text literal-block">
# version-specific patches
${CATEGORY}/${PN}/${PF}[-dddd].patch

# version-agnostic patches
${CATEGORY}/${PN}/${PN}[-dddd].patch
</pre>
<p>The <em>-dddd</em> part is optional and can be used to apply more than one patch to
an ebuild in the specified order. <em>d</em> should be a digit (0..9) and exactly
4 digits are expected. The not-numbered patch is always applied first.
So, in theory, up to 10001 patches per ebuild are supported.</p>
<p>The <em>default</em> (version-agnostic) patches are only applied to ebuilds for
which no version-specific patches exist.</p>
<p>Exempting a specific ebuild from being patched can be achieved by creating
an empty patch file (or a symlink to /dev/null). This is only necessary
if <em>default</em> patches are available, else it adds some overhead.</p>
<div class="caution">
<p class="first admonition-title">Caution!</p>
<p class="last">Don't try to patch the (R)DEPEND variables of an ebuild.
It will <em>randomly</em> break because <em>roverlay</em> uses unordered data structures
for collecting dependencies.</p>
</div>
<p>Example:</p>
<pre class="code text literal-block">
&lt;additions dir&gt;/sci-CRAN/R_oo/R_oo-1.9.8.patch
&lt;additions dir&gt;/sci-CRAN/R_oo/R_oo-1.9.8-0000.patch
&lt;additions dir&gt;/sci-CRAN/R_oo/R_oo-1.9.8-0001.patch
&lt;additions dir&gt;/sci-R/seewave/seewave-1.6.7.patch
&lt;additions dir&gt;/sci-R/seewave/seewave.patch
</pre>
</div>
<div class="section" id="importing-ebuilds">
<h2><a class="toc-backref" href="#contents">6.2&nbsp;&nbsp;&nbsp;Importing ebuilds</a></h2>
<p>Foreign ebuilds can be imported into the overlay by simple putting them into
the additions directory.</p>
<p>The naming convention is similar to ebuild patches and identical to the
portage tree:</p>
<pre class="code literal-block">
${CATEGORY}/${PN}/${PF}.ebuild
</pre>
<p>Ebuilds imported that way can not be overwritten by generated ebuilds and
benefit from most overlay creation features, e.g. Manifest file creation.
However, they cannot be used for metadata creation.</p>
<div class="important">
<p class="first admonition-title">Important</p>
<p class="last">Importing ebuilds is only supported by the default Manifest implementation
(<em>ebuildmanifest</em>).</p>
</div>
</div>
</div>
<div class="section" id="dependency-rules">
<h1><a class="toc-backref" href="#contents">7&nbsp;&nbsp;&nbsp;Dependency Rules</a></h1>
<div class="section" id="simple-dependency-rules">
<h2><a class="toc-backref" href="#contents">7.1&nbsp;&nbsp;&nbsp;Simple Dependency Rules</a></h2>
<p><em>Simple dependency rules</em> use a dictionary and string transformations
to resolve dependencies. <em>Fuzzy simple dependency rules</em> extend these by
a set of regular expressions, which allows to resolve many dependency strings
that minimally differ (e.g. only in the required version and/or comments:
<cite>R (&gt;= 2.10)</cite> and <cite>R [2.14] from http://www.r-project.org/</cite>) with a single
dictionary entry.</p>
<p>This is the only rule implementation currently available.</p>
<div class="section" id="rule-variants">
<h3><a class="toc-backref" href="#contents">7.1.1&nbsp;&nbsp;&nbsp;Rule Variants</a></h3>
<dl class="docutils">
<dt>default</dt>
<dd>The expected behavior of a dictionary-based rule: It matches one or more
<em>dependency string(s)</em> and resolves them as a <em>dependency</em>.</dd>
<dt>ignore</dt>
<dd>This variant will ignore <em>dependency strings</em>. Technically, it will
resolve them as <strong>nothing</strong>.</dd>
</dl>
</div>
<div class="section" id="rule-types">
<h3><a class="toc-backref" href="#contents">7.1.2&nbsp;&nbsp;&nbsp;Rule types</a></h3>
<dl class="docutils">
<dt>Simple Rules</dt>
<dd><p class="first">A simple rule resolves <strong>exact string matches</strong> (case-insensitive).</p>
<p>Example:
Given a rule <em>R</em> that says &quot;resolve 'R' and 'the R programming language'
as 'dev-lang/R'&quot;, any of these <em>dependency strings</em> will be resolved
as dev-lang/R:</p>
<ul class="last simple">
<li>r</li>
<li>THE R PROGRAMMING LanGuAgE</li>
<li>R</li>
</ul>
</dd>
<dt>Fuzzy Rules</dt>
<dd><p class="first">Fuzzy Rules are <strong>extended Simple Rules</strong>. If the basic lookup
as described above fails for a <em>dependency string</em>,
they will <em>try</em> to resolve it as a <strong>version-relative match</strong>.</p>
<p>To do this, the <em>dependency string</em> will be split into components like
<em>dependency name</em>, <em>dependency version</em> and useless comments, which are
discarded.
Then, if the <em>dependency name</em> matches a dictionary entry, a resolving
<em>dependency</em> will be created.</p>
<dl class="last docutils">
<dt>Example:</dt>
<dd><p class="first">Given the same rule as in the Simple Rules example, but as fuzzy rule
&quot;fuzzy-resolve 'R' and 'the R programming language' as 'dev-lang/R'&quot;,
it will resolve any of these <em>dependency strings</em>:</p>
<ul class="last simple">
<li>&quot;r&quot; as &quot;dev-lang/R&quot;</li>
<li>&quot;R 2.12&quot; as &quot;&gt;=dev-lang/R-2.12&quot;</li>
<li>&quot;The R PROGRAMMING LANGUAGE [&lt;2.14] from <a class="reference external" href="http://www.r-project.org/">http://www.r-project.org/</a>&quot;
as &quot;&lt;dev-lang/R-2.14&quot;</li>
<li>&quot;R ( !2.10 )&quot; as &quot;( !=dev-lang/R-2.10 dev-lang/R )&quot;</li>
</ul>
</dd>
</dl>
</dd>
</dl>
</div>
<div class="section" id="rule-file-examples">
<h3><a class="toc-backref" href="#contents">7.1.3&nbsp;&nbsp;&nbsp;Rule File Examples</a></h3>
<p>This sections lists some rule file examples.
See <a class="reference internal" href="#rule-file-syntax">Rule File Syntax</a> for a formal description.</p>
<dl class="docutils">
<dt>Example 1 - <em>default</em> fuzzy rule</dt>
<dd><p class="first">A rule that matches many dependencies on dev-lang/R, for example
&quot;r 2.12&quot;, &quot;R(&gt;= 2.14)&quot;, &quot;R [&lt;2.10]&quot;, &quot;r{  !2.12 }&quot;, and &quot;R&quot;, and
resolves them as '&gt;=dev-lang/R-2.12', '&gt;=dev-lang/R-2.14',
'&lt;dev-lang/R-2.10', etc.:</p>
<pre class="code text last literal-block">
~dev-lang/R :: R
</pre>
</dd>
<dt>Example 2 - <em>default</em> simple rule stub</dt>
<dd><p class="first">A rule that case-insensitively matches 'zoo' and resolves it as 'sci-R/zoo',
assuming the OVERLAY_CATEGORY is set to 'sci-R':</p>
<pre class="code text literal-block">
zoo
</pre>
<div class="note last">
<p class="first admonition-title">Note</p>
<p class="last">R Package rules are dynamically created at runtime and therefore not
needed. Write them only if certain R package dependencies cannot
be resolved. See <em>Selfdep</em> in <a class="reference internal" href="#rule-file-syntax">Rule File Syntax</a> for details.</p>
</div>
</dd>
<dt>Example 3 - <em>default</em> simple rule</dt>
<dd><p class="first">A rule that matches several <em>dependency strings</em> and resolves them
as &quot;sci-libs/gdal and sci-libs/proj&quot;:</p>
<pre class="code text last literal-block">
( sci-libs/gdal sci-libs/proj ) {
   for building from source: GDAL &gt;= 1.3.1 &amp;&amp; GDAL &lt; 1.6.0 (until tested) library and PROJ.4 (proj &gt;= 4.4.9)
   for building from source: GDAL &gt;= 1.3.1 library and PROJ.4 (proj &gt;= 4.4.9)
   for building from source: GDAL &gt;= 1.3.1 library and PROJ.4(proj &gt;= 4.4.9)
   for building from source: GDAL &gt;= 1.6.0 library and PROJ.4(proj &gt;= 4.4.9)
}
</pre>
</dd>
<dt>Example 4 - <em>ignore</em> simple rule</dt>
<dd><p class="first">A rule that matches text that should be ignored.
This is a good way to deal with free-style text found
in some R package DESCRIPTION files.</p>
<pre class="code text last literal-block">
! {
   see README
   read INSTALL
   Will use djmrgl or rgl packages for rendering if present
}
</pre>
</dd>
</dl>
<p>Please see the default rule files for more extensive examples that cover
other aspects like limiting a rule to certain dependency types.
They can be found in <em>/etc/roverlay/simple-deprules.d</em> if <em>roverlay</em> has been
installed with <em>emerge</em>, else in <em>&lt;R Overlay src directory&gt;/simple-deprules.d</em>.</p>
</div>
<div class="section" id="rule-file-syntax">
<span id="dependency-rule-file-syntax"></span><h3><a class="toc-backref" href="#contents">7.1.4&nbsp;&nbsp;&nbsp;Rule File Syntax</a></h3>
<p>Simple dependency rule files have a special syntax. Each rule is introduced
with the resolving <em>dependency</em> prefixed by a <em>keychar</em> that sets the rule
type if required. The <em>dependency strings</em> resolved by this rule are listed
after a rule separator or within a rule block. Leading/trailing whitespace
is ignored.</p>
<dl class="docutils">
<dt>Ignore rules</dt>
<dd>have only a keychar but no <em>dependency</em>.</dd>
<dt>Keychars</dt>
<dd><p class="first">set the rule type.</p>
<ul class="simple">
<li><strong>!</strong> introduces a <em>ignore</em> simple rule</li>
<li><strong>~</strong> introduces a <em>default</em> fuzzy rule</li>
<li><strong>%</strong> introduces a <em>ignore</em> fuzzy rule</li>
</ul>
<p class="last">Anything else is not treated as keychar and thus introduces a <em>default</em>
simple rule.</p>
</dd>
<dt>Keywords</dt>
<dd><p class="first">There are two keywords that control how a rule file is read.</p>
<p>The important one is the <em>#deptype &lt;dependency type&gt;</em> directive that
defines that all rules until the next <em>deptype</em> directory or end of file,
whatever comes first, will only match <em>dependency strings</em>
with the specified <em>dependency type</em>.</p>
<p>Available dependency types are</p>
<ul class="simple">
<li><em>all</em> (no type restrictions)</li>
<li><em>pkg</em> (resolve only R package dependencies)</li>
<li><em>sys</em> (resolve only system dependencies)</li>
</ul>
<p class="last">The other keyword is <em>#! NOPARSE</em> which stops parsing of a rule file.</p>
</dd>
<dt>Dependencies</dt>
<dd><p class="first">are strings that are recognized by portage as <strong>Dynamic DEPENDs</strong>
(see the ebuild(5) man page).</p>
<p>Examples:</p>
<blockquote>
<ul class="simple">
<li>dev-lang/R</li>
<li>( media-libs/tiff &gt;=sci-libs/fftw-3 )</li>
<li>&gt;=x11-drivers/nvidia-drivers-270</li>
</ul>
</blockquote>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The fuzzy rule types support <strong>DEPEND Atom Bases</strong> only.</p>
</div>
<div class="warning last">
<p class="first admonition-title">Warning</p>
<p class="last">Dependency strings cannot start with <em>~</em> as it is a keychar.
Use braces <em>( ~... )</em> to work around that.</p>
</div>
</dd>
<dt>Single line rules</dt>
<dd><p class="first">resolve exactly one <em>dependency string</em>. Their rule separator is ' :: '.</p>
<dl class="last docutils">
<dt>Syntax:</dt>
<dd><pre class="code text first last literal-block">
[&lt;keychar&gt;]&lt;dependency&gt; :: &lt;dependency string&gt;
</pre>
</dd>
</dl>
</dd>
<dt>Multi line rules</dt>
<dd><p class="first">resolve several <em>dependency strings</em>.
Their rule block begins with '{' + newline, followed by one
<em>dependency string</em> per line, and ends with '}' in a separate line.</p>
<dl class="docutils">
<dt>Syntax:</dt>
<dd><pre class="code text first last literal-block">
[&lt;keychar&gt;]&lt;dependency&gt; {
   &lt;dependency string&gt;
   [&lt;dependency string&gt;]
   ...
}
</pre>
</dd>
</dl>
<div class="note last">
<p class="first admonition-title">Note</p>
<p class="last">Technically, this rule syntax can be used to specify rules with
zero or more <em>dependency strings</em>. An empty rule makes little sense,
though.</p>
</div>
</dd>
<dt>Comments</dt>
<dd>start with <strong>#</strong>. There are a few exceptions to that, the <em>#deptype</em> and
<em>#! NOPARSE</em> keywords. Comments inside rule blocks are not allowed and
will be read as normal <em>dependency strings</em>.</dd>
<dt>Selfdep</dt>
<dd><p class="first">This is another name for <em>dependency strings</em> that are resolved by an
R package with the same name, which is also part of the overlay being
created.</p>
<p>Example: <em>zoo</em> is resolved as <em>sci-R/zoo</em>, assuming that <a class="reference internal" href="#overlay-category">OVERLAY_CATEGORY</a>
is set to <em>sci-R</em></p>
<p>Writing selfdep rules is not necessary since <em>roverlay</em> automatically
creates rules for all known R packages (see <a class="reference internal" href="#dynamic-selfdep-rule-pool">Dynamic Selfdep Rule Pool</a>
for details).</p>
<p>There are a few exceptions to that in which case selfdep rules have to
be written:</p>
<ul class="simple">
<li>The <em>dependency string</em> is assumed to be a system dependency (not an
R package). This is likely a &quot;bug&quot; in the DESCRIPTION file of the
R package being processed.</li>
<li>The R package name is not ebuild-name compliant (e.g. contains the '.'
char, which is remapped to '_'.).
Most <em>char remap</em> cases are handled properly, but there may be a few
exceptions.</li>
</ul>
<div class="caution last">
<p class="first admonition-title">Caution!</p>
<p class="last">Writing unnecessary selfdep rules slows dependency resolution down!
Each rule will exist twice, once as <em>dynamic</em> rule and once as
the written one.</p>
</div>
</dd>
<dt>Rule Stubs</dt>
<dd><p class="first">Selfdeps can be written using a shorter syntax.
For example, if your OVERLAY_CATEGORY is <em>sci-R</em>, <em>zoo</em> should be resolved
as <em>sci-R/zoo</em>. This rule can be written as a single word, <em>zoo</em>.</p>
<dl class="last docutils">
<dt>Syntax:</dt>
<dd><pre class="code text first last literal-block">
[&lt;keychar&gt;]&lt;short dependency&gt;
</pre>
</dd>
</dl>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="package-rules">
<h1><a class="toc-backref" href="#contents">8&nbsp;&nbsp;&nbsp;Package Rules</a></h1>
<p>Package Rules can be used to control both overlay and ebuild creation.
Each package rule consists of conditions, e.g. <em>package name contains amd64</em>,
and actions, e.g. <em>set KEYWORDS=&quot;-x86 amd64&quot;</em>.
The actions of a rule will only be applied if a package meets all conditions,
otherwise the rule does nothing.
Moreover, rules can contain further rules which will only take effect if all
enclosing rules match a given package.</p>
<div class="section" id="package-rule-file-syntax">
<h2><a class="toc-backref" href="#contents">8.1&nbsp;&nbsp;&nbsp;Package Rule File Syntax</a></h2>
<p>As stated above, each rule has two parts, a <em>match block</em> that lists the
rule's conditions and an <em>action block</em> that defines which actions and
nested rules are applied to a package if the rule matches it, i.e. if all
conditions are met.</p>
<p>A rule file contains zero or more package rules.
Each rule has to declare one <em>match</em> and one <em>action statement</em> at least.
The basic syntax for a rule with 1..m <em>match</em> and 1..n <em>action statements</em> is</p>
<pre class="code literal-block">
MATCH:
   &lt;match statement 1&gt;
   &lt;match statement 2&gt;
   ...
   &lt;match statement m&gt;
ACTION:
   &lt;action statement 1&gt;
   &lt;action statement 2&gt;
   ...
   &lt;action statement n&gt;
END;
</pre>
<p>A rule is introduced by the <tt class="docutils literal">MATCH:</tt> keyword, which starts the
<em>match block</em> and is followed by one or more <em>match statements</em>, one per line.
The <em>match block</em> ends with the <tt class="docutils literal">ACTION:</tt> keyword, which also starts the
<em>action block</em> and is followed by one or more <em>action statements</em>
(again, one per line). Finally, the rule is terminated by the <tt class="docutils literal">END;</tt> keyword.</p>
<p>Indention is purely optional, leading and ending whitespace will be discarded.
Lines starting with <tt class="docutils literal">#</tt> or <tt class="docutils literal">;</tt> are considered to be comments and will be
ignored.</p>
<div class="section" id="match-blocks">
<h3><a class="toc-backref" href="#contents">8.1.1&nbsp;&nbsp;&nbsp;Match Blocks</a></h3>
<p>The <em>match block</em> lists one or more conditions, which all must evaluate to
<em>true</em> for a certain package, otherwise no actions will be applied.
There are two types of conditions, <em>trivial</em> conditions,
e.g. <em>always true/false</em> or <em>random - flip a coin</em>, and <em>non-trivial</em> ones
that depend on the information a package has, e.g. its repository or name.</p>
<p>Only <em>non-trivial</em> conditions can be defined in <em>match statements</em>.
The consist of a <strong>match keyword</strong> that defines <em>what</em> should be matched, an
<strong>accepted value</strong> to compare against and an <strong>operator</strong> that defines the
relation <em>accepted value - package's information</em>, i.e. <em>how</em> to compare.
The operator can be omitted, in which case it is determined by the
<em>match keyword</em>.</p>
<p>The <em>match statement</em> syntax is</p>
<pre class="code literal-block">
&lt;match keyword&gt; [&lt;operator&gt;] &lt;accepted value&gt;
</pre>
<p>These <em>match keywords</em> are recognized:</p>
<table border="1" class="docutils">
<caption>match statement keywords</caption>
<colgroup>
<col width="21%" />
<col width="25%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">match keyword</th>
<th class="head">default operator</th>
<th class="head">matches</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>repo</td>
<td>nocase-string</td>
<td><em>alias to repo_name</em></td>
</tr>
<tr><td>repo_name</td>
<td>nocase-string</td>
<td>name of the repo, e.g. <em>CRAN</em></td>
</tr>
<tr><td>package</td>
<td><em>implicit</em></td>
<td>package file name with version
but without the file extension, e.g.
<em>rpart.plot_1.3-0</em></td>
</tr>
<tr><td>package_name</td>
<td><em>implicit</em></td>
<td>package file name without version
and file extension, e.g. <em>seewave</em></td>
</tr>
<tr><td>ebuild_name</td>
<td><em>implicit</em></td>
<td>ebuild name <tt class="docutils literal">${PN}</tt>, which is the
package_name with special chars
removed or replaced (e.g.,
<em>R.oo</em> (pkg) =&gt; <em>R_oo</em> (ebuild))</td>
</tr>
<tr><td>name</td>
<td><em>implicit</em></td>
<td><em>alias to ebuild_name</em></td>
</tr>
</tbody>
</table>
<p>Note the <strong>implicit operator</strong>. It will be used whenever no explicit operator
has been specified in the match statement and the match keyword does not
define a default one. Four explicit operators are available:</p>
<table border="1" class="docutils">
<caption>match statement operators</caption>
<colgroup>
<col width="21%" />
<col width="18%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">operator name</th>
<th class="head">operator(s)</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>exact-string</td>
<td>== =</td>
<td>exact string match</td>
</tr>
<tr><td>nocase-string</td>
<td>,= =,</td>
<td>case-insensitive string match</td>
</tr>
<tr><td>exact-regex</td>
<td>~= =~</td>
<td>exact regex match <em>^&lt;expression&gt;$</em></td>
</tr>
<tr><td>regex</td>
<td>~~ ~</td>
<td>partial regex match</td>
</tr>
<tr><td><em>implicit</em></td>
<td><em>none</em></td>
<td><em>exact-regex</em> operator if <em>accepted value</em>
has any wildcard characters (?, *), else
<em>exact-string</em>. Wildcard chars will
be replaced with their regex equivalents.</td>
</tr>
</tbody>
</table>
<p>The <em>accepted value</em> is a simple string or a regular expression,
which depends on the operator.</p>
<div class="section" id="extended-match-block-syntax">
<h4><a class="toc-backref" href="#contents">8.1.1.1&nbsp;&nbsp;&nbsp;Extended Match Block Syntax</a></h4>
<p>Sometimes, a rule should apply its actions to a package if it matches <em>any</em>
condition, e.g. <em>package from CRAN or BIOC</em>, or if it does not match a certain
condition, e.g. <em>package not from BIOC/experiment</em>.</p>
<p>This is supported by special <em>match keywords</em> that represent
<em>boolean functions</em>. Such a <em>match statement</em> is introduced by the keyword,
followed by one or more <em>match statements</em> that are indented by one asterisk
<tt class="docutils literal">*</tt> or dash <tt class="docutils literal">-</tt> character for each <em>boolean function</em> that is currently
active. These characters are important and indicate the <em>match depth</em>.
A depth of 0 means that no function is active.</p>
<p>Syntax Example:</p>
<pre class="code literal-block">
MATCH:
   &lt;match statement 1, match depth 0&gt;
   ...
   &lt;boolean function&gt;
   * &lt;match statement 1, match depth 1&gt;
   * &lt;match statement 2, match depth 1&gt;
   * ...
   * &lt;match statement m, match depth 1&gt;
   ...
   &lt;match statement n, match depth 0&gt;
ACTION:
   ...
END;
</pre>
<p>For reference, the following table lists the <em>boolean functions</em> available,
their <em>match keywords</em> and their meaning:</p>
<table border="1" class="docutils">
<caption>boolean functions</caption>
<colgroup>
<col width="25%" />
<col width="18%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">boolean function</th>
<th class="head">match
keyword(s)</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>AND</td>
<td>and all &amp;&amp;</td>
<td>all listed conditions must match</td>
</tr>
<tr><td>OR</td>
<td>or ||</td>
<td>any
of the listed conditions must match</td>
</tr>
<tr><td>XOR1</td>
<td>xor1 xor ^^</td>
<td>exactly one
of the listed conditions must match</td>
</tr>
<tr><td>NOR</td>
<td>nor none</td>
<td>none
of the listed conditions must match</td>
</tr>
</tbody>
</table>
<p>In other words, a (boolean) match keyword starts a <em>nested match block</em>
at any position in the current one and increases the <em>match depth</em> by one.
The nested block is terminated by indenting out, i.e. decreasing the
<em>match depth</em> by one. The (extended) match statement syntax then becomes:</p>
<pre class="code literal-block">
&lt;'*'^&lt;match_depth&gt;&gt; &lt;(basic) match statement&gt;
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p>The extended match statement syntax does not support boolean functions
with a fixed number of conditions, e.g. 1. This is why there is no
<em>NOT</em> function. The definition for more than one condition would be
ambiguous, either <em>NOR</em> or <em>NAND</em>.</p>
<p class="last">Correspondingly, the logic for the top-level match block is <em>AND</em> by
convention.</p>
</div>
<p>Using this syntax, match blocks can be nested indefinitely (minus technical
limitations):</p>
<pre class="code literal-block">
MATCH:
   &lt;match statement 1, depth 0&gt;
   &lt;boolean function 2, depth 0&gt;
   * &lt;match statement 1, depth 1&gt;
   * &lt;match statement 2, depth 1&gt;
   * ...
   * &lt;match statement k-1, depth 1&gt;
   * &lt;boolean function k, depth 1&gt;
   ** &lt;match statement 1, depth 2&gt;
   ** ...
   ** &lt;match statement o, depth 2&gt;
   * &lt;match statement k+1, depth 1&gt;
   * ...
   * &lt;match statement m, depth 1&gt;
   ...
   &lt;match statement n, depth 0&gt;
ACTION:
   ...
END;
</pre>
</div>
</div>
<div class="section" id="action-blocks">
<h3><a class="toc-backref" href="#contents">8.1.2&nbsp;&nbsp;&nbsp;Action Blocks</a></h3>
<p>The action block syntax is quite simple. Each <em>action statement</em> starts
with an <em>action keyword</em>, optionally followed by one or more <em>values</em>.</p>
<p>Action statement syntax:</p>
<pre class="code literal-block">
&lt;action keyword&gt; [&lt;value&gt;]*
</pre>
<p>The value(s) can be enclosed by quotation characters (<tt class="docutils literal">&quot;</tt>, <tt class="docutils literal">'</tt>).</p>
<p>The following table lists all <em>action keywords</em>, their impact (<em>what</em> they
control <em>where</em>) and the number of values they accept:</p>
<table border="1" class="docutils">
<caption>action keywords</caption>
<colgroup>
<col width="23%" />
<col width="25%" />
<col width="18%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">action keyword</th>
<th class="head">affects</th>
<th class="head"># of values</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ignore</td>
<td rowspan="2">overlay creation</td>
<td rowspan="2">none</td>
<td rowspan="2">ignore package,
do not try to create
an ebuild for it</td>
</tr>
<tr><td>do-not-process</td>
</tr>
<tr><td>keywords</td>
<td>ebuild variables</td>
<td>&gt;= 1</td>
<td>set per-package
<tt class="docutils literal">KEYWORDS</tt></td>
</tr>
<tr><td rowspan="2">trace</td>
<td rowspan="2">package rules</td>
<td>none</td>
<td>mark a package as
modified</td>
</tr>
<tr><td>1</td>
<td>add the stored string
to a package's
<em>modified</em> variable
whenever this action
is applied</td>
</tr>
<tr><td>set</td>
<td rowspan="2">package
metadata,
overlay creaton</td>
<td>2</td>
<td rowspan="2">set package
information</td>
</tr>
<tr><td>set_&lt;key&gt;</td>
<td>1</td>
</tr>
<tr><td>rename</td>
<td rowspan="2">package
metadata,
overlay creation</td>
<td>2</td>
<td rowspan="2">modify package
information with
sed-like
<em>s/expr/repl/</em>
statements</td>
</tr>
<tr><td>rename_&lt;key&gt;</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>The two-arg form of the set/rename keywords expect a &lt;key&gt; as first and
a value / sed expression as second arg. The one-arg form expects the latter
one only. The &quot;/&quot; delimitier in the sed expression can be any character.</p>
<p>The following <em>info keys</em> can be set and/or modified:</p>
<table border="1" class="docutils">
<caption>info keys for set/rename</caption>
<colgroup>
<col width="19%" />
<col width="29%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">info key</th>
<th class="head">supports set/rename</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>name</td>
<td>yes / yes</td>
<td>rename the ebuild</td>
</tr>
<tr><td>category</td>
<td>yes / <strong>no</strong></td>
<td>set package category</td>
</tr>
<tr><td>destfile</td>
<td>yes / yes</td>
<td>rename ebuild destfile by using the
'-&gt;' operator in <tt class="docutils literal">${SRC_URI}</tt></td>
</tr>
</tbody>
</table>
<div class="caution">
<p class="first admonition-title">Caution!</p>
<p class="last">Category moves are not handled automatically. In incremental mode, overlay
creation has to be called with either <tt class="docutils literal"><span class="pre">--fixup-category-move</span></tt> or
<tt class="docutils literal"><span class="pre">--fixup-category-move-reverse</span></tt>, depending on whether the package(s)
have been moved away from the default category or back to the default
category (&quot;reverse&quot;). Configuring both category move types at once requires
a full recreation of the overlay, that is <tt class="docutils literal">rm <span class="pre">-rf</span> &lt;overlay dir&gt;</tt>
followed by <tt class="docutils literal">roverlay create</tt>.</p>
</div>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Applying the same (non-incremental) ebuild variable, set or rename action
more than once is possible, but only the last one will have an effect
on ebuild creation.</p>
</div>
<div class="section" id="extended-action-block-syntax">
<h4><a class="toc-backref" href="#contents">8.1.2.1&nbsp;&nbsp;&nbsp;Extended Action Block Syntax</a></h4>
<p>A mentioned before, action blocks can contain <em>nested rules</em>. The syntax
is exactly the same as for the normal package rules:</p>
<pre class="code literal-block">
MATCH:
   # top-level rule, match block
   ...
ACTION:
   # top-level rule, action block
   ...
   MATCH:
      # nested rule, match block
      ...
   ACTION:
      # nested rule, action block
      ...
   END;
   # top-level rule, action block continues
   ...
END;
</pre>
<p>Rules can be nested indefinitely, whitespace indention is optional.
A <em>nested rule</em> only becomes active, i.e. tries to match a package, if its
enclosing rule already matched it. This can be used to reduce the number of
checks necessary for a given package.</p>
</div>
</div>
<div class="section" id="package-rule-examples">
<h3><a class="toc-backref" href="#contents">8.1.3&nbsp;&nbsp;&nbsp;Package Rule Examples</a></h3>
<p>A rule that ignores the 'yaqcaffy' package from CRAN, which is also available
from BIOC:</p>
<pre class="code literal-block">
MATCH:
   repo         == CRAN
   package_name == yaqcaffy
ACTION:
   do-not-process
END;
</pre>
<p>A more complex example that sets the <tt class="docutils literal">KEYWORDS</tt> ebuild variable for
all packages whose name contains <em>amd64</em> or <em>x86_64</em> to <tt class="docutils literal"><span class="pre">-x86</span> ~amd64</tt>
if the package is from BIOC/experiment, and otherwise to <tt class="docutils literal"><span class="pre">-x86</span> amd64</tt>:</p>
<pre class="code literal-block">
MATCH:
   or
   * package_name ~ x86_64
   * package_name ~ amd64
ACTION:
   keywords &quot;-x86 amd64&quot;
   MATCH:
      repo == BIOC/experiment
   ACTION:
      keywords &quot;-x86 ~amd64&quot;
   END;
END;
</pre>
<p>A rule that assigns all packages from BIOC-2.10/bioc to sci-bioc:</p>
<pre class="code literal-block">
MATCH:
   repo == BIOC-2.10/bioc
ACTION:
   set category sci-bioc
END;

# alternatively:
MATCH:
   repo == BIOC-2.10/bioc
ACTION:
   set_category sci-bioc
END;
</pre>
<p>The following example prefixes all <em>yaml</em> packages with <em>Rpkg_</em>:</p>
<pre class="code literal-block">
MATCH:
   ebuild_name ,= yaml
ACTION:
   rename destfile s/^/Rpkg_/
END;
</pre>
<p>Moving such packages to a &quot;R-package&quot; sub directory would be possible, too:</p>
<pre class="code literal-block">
MATCH:
   name ,= yaml
ACTION:
   rename_destfile s=^=R-package/=
END;
</pre>
</div>
</div>
</div>
<div class="section" id="event-hooks">
<h1><a class="toc-backref" href="#contents">9&nbsp;&nbsp;&nbsp;Event Hooks</a></h1>
<p><em>roverlay</em> is able to call a script when certain events occur, e.g. after
successful overlay creation, which can be used to perform additional actions
without touching <em>roverlay's</em> source code.</p>
<p>To realize this, <em>roverlay</em> determines whether a given event is permitted
(<a class="reference internal" href="#event-policy">event policy</a>) and, if so, creates a <a class="reference internal" href="#hook-environment">hook environment</a> and runs the
script. Additionally, shell scripts can load <em>roverlay's</em> <em>$FUNCTIONS</em> file,
which provides extra functionality.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last"><em>roverlay</em> waits until the script terminates and thus possibly waits
forever.</p>
</div>
<div class="section" id="default-event-script">
<h2><a class="toc-backref" href="#contents">9.1&nbsp;&nbsp;&nbsp;Default event script</a></h2>
<p>The default event script (<tt class="docutils literal">mux.sh</tt>) loads <em>$FUNCTIONS</em> and then runs the
following script files (by sourcing them), in order:</p>
<ol class="arabic simple">
<li>all files from <a class="reference internal" href="#additions-dir">ADDITIONS_DIR</a>/hooks/&lt;event&gt; that end with <em>.sh</em>
(<tt class="docutils literal"><span class="pre">&lt;ADDITIONS_DIR&gt;/hooks/&lt;event&gt;/*.sh</span></tt>)</li>
<li>all files <a class="reference internal" href="#additions-dir">ADDITIONS_DIR</a>/hooks that end with <em>.&lt;event&gt;</em>
(<tt class="docutils literal"><span class="pre">&lt;ADDITIONS_DIR&gt;/hooks/*.&lt;event&gt;</span></tt>)</li>
</ol>
<p>So, there are two naming schemes for <em>hook scripts</em>.
Either one is acceptable, but it is advised to stay consistent.
Having the same script at both locations results in executing it twice.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The default event script enables <em>nounset</em> behavior, which causes the
shell command interpreter to exit abnormally if an unset variable is
accessed.</p>
</div>
<div class="section" id="activating-a-hook-script">
<h3><a class="toc-backref" href="#contents">9.1.1&nbsp;&nbsp;&nbsp;Activating a hook script</a></h3>
<p>Activating a hook script can be done by symlinking it:</p>
<pre class="code text literal-block">
ln -s &lt;real script&gt; ${ADDITIONS_DIR}/hooks/&lt;event&gt;/&lt;name&gt;.sh
# or
ln -s &lt;real script&gt; ${ADDITIONS_DIR}/hooks/&lt;name&gt;.&lt;event&gt;
</pre>
</div>
<div class="section" id="adding-a-new-hook-script">
<h3><a class="toc-backref" href="#contents">9.1.2&nbsp;&nbsp;&nbsp;Adding a new hook script</a></h3>
<p>As hinted before, <em>hook scripts</em> are simple shell scripts. The following
template gives an idea of how to write them:</p>
<pre class="code sh literal-block">
<span class="comment">#!/bin/sh
#set -u
</span>
<span class="comment"># load essential functions
# (not necessary when using the default event script)
</span>. <span class="literal string double">&quot;${FUNCTIONS?}&quot;</span> <span class="operator">||</span> <span class="name builtin">exit</span>

<span class="comment">## load additional function files, if any
#$lf &lt;name(s)&gt;
</span>
<span class="comment"># script body
#
# when redirecting output to $DEVNULL, use &quot;&gt;&gt;&quot; instead of &quot;&gt;&quot; as
# $DEVNULL could be a file
#ls &gt;&gt;${DEVNULL}
#
# ...
</span>

<span class="comment"># the script must not exit if everything went well (return is ok)
</span><span class="keyword">return </span>0
</pre>
</div>
</div>
<div class="section" id="event-policy">
<h2><a class="toc-backref" href="#contents">9.2&nbsp;&nbsp;&nbsp;Event Policy</a></h2>
<p>The <em>event policy</em> controls whether a certain event actually triggers a script
call or not.
It is constructed by parsing the <a class="reference internal" href="#event-hook-restrict">EVENT_HOOK_RESTRICT</a> config option:</p>
<ul class="simple">
<li>a word prefixed by <tt class="docutils literal">-</tt> means <em>deny specific event</em> (-&gt; blacklist)</li>
<li>the asterisk char <tt class="docutils literal">*</tt> (or <tt class="docutils literal">+*</tt>) sets the policy to
<em>allow unless denied</em> (blacklist) or <em>allow all</em></li>
<li>a word prefixed by <tt class="docutils literal">+</tt> or without a prefix char means
<em>allow specific event</em> (-&gt; whitelist)</li>
<li>the asterisk char with <tt class="docutils literal">-</tt> as prefix (<tt class="docutils literal"><span class="pre">-*</span></tt>) sets the policy to
<em>deny unless allowed</em> (whitelist) or <em>deny all</em></li>
</ul>
<p>The policy defaults to <em>allow all</em> if <tt class="docutils literal">EVENT_HOOK_RESTRICT</tt> is not set in
the config file. An empty string sets the policy to <em>deny all</em>.</p>
</div>
<div class="section" id="hook-environment">
<h2><a class="toc-backref" href="#contents">9.3&nbsp;&nbsp;&nbsp;Hook Environment</a></h2>
<table border="1" class="docutils">
<caption>environment variables provided by <em>roverlay</em></caption>
<colgroup>
<col width="21%" />
<col width="25%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">variable</th>
<th class="head">source</th>
<th class="head">notes / description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>PATH</td>
<td>os.environ</td>
<td>&nbsp;</td>
</tr>
<tr><td>LOGNAME</td>
<td>os.environ</td>
<td>&nbsp;</td>
</tr>
<tr><td>SHLVL</td>
<td>os.environ</td>
<td>&nbsp;</td>
</tr>
<tr><td>TERM</td>
<td>os.environ</td>
<td>&nbsp;</td>
</tr>
<tr><td>HOME</td>
<td>os.environ</td>
<td>&nbsp;</td>
</tr>
<tr><td>ROVERLAY_PHASE</td>
<td>event</td>
<td>event that caused the script to run</td>
</tr>
<tr><td>OVERLAY</td>
<td>config</td>
<td rowspan="3">overlay directory (<a class="reference internal" href="#overlay-dir">OVERLAY_DIR</a>),
initial working directory</td>
</tr>
<tr><td>S</td>
<td><em>$OVERLAY</em></td>
</tr>
<tr><td>PWD</td>
<td><em>$OVERLAY</em></td>
</tr>
<tr><td>DISTROOT</td>
<td>config</td>
<td>package mirror directory
(<a class="reference internal" href="#overlay-distdir-root">OVERLAY_DISTDIR_ROOT</a>)</td>
</tr>
<tr><td>TMPDIR</td>
<td>os.environ,
<em>fallback</em></td>
<td rowspan="2">directory for temporary files</td>
</tr>
<tr><td>T</td>
<td><em>$TMPDIR</em></td>
</tr>
<tr><td>ADDITIONS_DIR</td>
<td>config</td>
<td rowspan="2">directory with supplementary files
(<a class="reference internal" href="#overlay-additions-dir">OVERLAY_ADDITIONS_DIR</a>)</td>
</tr>
<tr><td>FILESDIR</td>
<td><em>$ADDITIONS_DIR</em></td>
</tr>
<tr><td>SHLIB</td>
<td><em>$ADDITIONS_DIR</em>,
<em>installed?</em></td>
<td>A list of directories with shell
function files
(optional, only set if any dir exists)</td>
</tr>
<tr><td>FUNCTIONS</td>
<td><em>$ADDITIONS_DIR</em>,
<em>installed?</em></td>
<td>file with essential shell functions
(optional, only set if it exists)</td>
</tr>
<tr><td>DEBUG</td>
<td>log level</td>
<td><em>shbool</em> (<tt class="docutils literal">y</tt> or <tt class="docutils literal">n</tt>) that
indicates whether debug messages should
be printed</td>
</tr>
<tr><td>VERBOSE</td>
<td>log level</td>
<td><em>shbool</em></td>
</tr>
<tr><td>QUIET</td>
<td>log level</td>
<td><em>shbool</em> that indicates whether scripts
should be quiet</td>
</tr>
<tr><td>NO_COLOR</td>
<td><em>n/a</em></td>
<td><em>shbool</em>. Always set to <em>y</em> since
colored output should not be produced</td>
</tr>
<tr><td>NOSYNC</td>
<td>config</td>
<td><em>shbool</em> that indicates whether data
transfers from/to remote machines is
allowed (<a class="reference internal" href="#nosync">NOSYNC</a>)</td>
</tr>
<tr><td>EBUILD</td>
<td>config</td>
<td>the <em>ebuild</em> executable</td>
</tr>
<tr><td>GIT_EDITOR</td>
<td><em>n/a</em></td>
<td rowspan="2">set to <em>/bin/false</em></td>
</tr>
<tr><td>GIT_ASKPASS</td>
<td><em>n/a</em></td>
</tr>
</tbody>
</table>
<p>The default <em>essential shell functions</em> file (<em>$FUNCTIONS</em>) makes,
when included in the hook script, most of the enviroment variables readonly.</p>
<table border="1" class="docutils">
<caption>variables provided by <em>$FUNCTIONS</em></caption>
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">variable</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>IFS_DEFAULT</td>
<td>default <em>internal field separator</em></td>
</tr>
<tr><td>IFS_NEWLINE</td>
<td><em>IFS</em> for iterating over text lines</td>
</tr>
<tr><td>DEVNULL</td>
<td><em>/dev/null</em> target (could also be a file)</td>
</tr>
<tr><td>EX_ERR</td>
<td>default error exit code</td>
</tr>
<tr><td>EX_ARG_ERR</td>
<td>default exit code for arg errors</td>
</tr>
<tr><td>SCRIPT_FILENAME</td>
<td>file name of the hook script</td>
</tr>
<tr><td>SCRIPT_NAME</td>
<td>name of the hook script (without file extension)</td>
</tr>
<tr><td>lf</td>
<td>reference to a function that loads additional shell
function files</td>
</tr>
</tbody>
</table>
<p><em>$FUNCTIONS</em> also provides a number of shell functions:</p>
<pre class="code sh literal-block">
<span class="comment"># --- message ---
#
# void veinfo ( message )
#  Prints a message to stdout if $DEBUG is set to 'y'.
#
# void einfo  ( message )
#  Prints a message to stdout if $VERBOSE is set to 'y'.
#
# void ewarn  ( message )
#  Prints a message to stderr unless $QUIET is set to 'y'.
#
# void eerror ( message )
#  Prints a message to stderr.
#
#
# --- core ---
#
# &#64;noreturn die ( [message], [exit_code] ), raises exit()
#  Lets the script die with the given message/exit code.
#
# &#64;noreturn OUT_OF_BOUNDS(), raises die()
#  Lets the script die due to insufficient arg count.
#
# int run_command ( *cmdv )
#  Logs a command and runs it afterwards.
#
# int run_command_logged ( *cmdv )
#  Logs a command, runs it and logs the result.
#
# void autodie ( *cmdv ), raises die()
#  Runs a command. Lets the script die if the command fails.
#
#
# void load_functions ( *filenames, **SHLIB ), raises die()
#  Loads additional shell functions file(s) from $SHLIB.
#  (Referenced by $lf.)
#
# void dont_run_as_root(), raises die()
#  Lets the script die if it is run as root.
#
# int list_has ( word, *list_items )
#  Returns 0 if $word is in the given list, else 1.
#
# int qwhich ( *command )
#  Returns 0 if all listed commands are found by &quot;which&quot;, else 1.
#
#
# --- fs ---
#
# int dodir ( *dir )
#  Ensures that zero or more directories exist by creating them if
#  necessary. Returns the number of directories that could not be created.
#
#
# --- str ---
#
# int yesno ( word, **YESNO_YES=0, **YESNO_NO=1, **YESNO_EMPTY=2 )
#  Returns $YESNO_YES if $word means &quot;yes&quot;, $YESNO_EMPTY if $word is empty
#  and $YESNO_NO otherwise (if $word probably means &quot;no&quot;).
#
# ~int str_trim ( *args )
#  Removes whitespace at the beginning and end of a string and replaces
#  any whitespace sequence within the string with a single space char.
#  Passes the return value of the underlying sed command.
#
# ~int str_upper ( *args )
#  Echoes the uppercase variant of stdin or *args.
#  Passes tr's return value.
#
# ~int str_lower ( *args )
#  Echoes the lowercase variant of stdin or *args.
#  Passes tr's return value.
#
# ~int str_field ( fieldspec, *args, **FIELD_SEPARATOR=' ' )
#  Echoes the requested fields of stdin or *args.
#  Passes cut's return value.
#
#
# --- int ---
#
# int is_int ( word )
#  Returns 0 if $word is an integer, else 1.
#
# int is_natural ( word )
#  Returns 0 if $word is an integer &gt;= 0, else 1.
#
# int is_positive ( word )
#  Returns 0 if $word is an integer &gt;= 1, else 1.
#
# int is_negative ( word )
#  Returns 0 if $word is an integer &lt; 0, else 1.
#</span>
</pre>
</div>
<div class="section" id="adding-a-function-file">
<h2><a class="toc-backref" href="#contents">9.4&nbsp;&nbsp;&nbsp;Adding a function file</a></h2>
<p>Function files are shell script files that provide functions and variables.
They should, however, not execute any code directly.</p>
<p>The template below illustrates how to write function files:</p>
<pre class="code sh literal-block">
<span class="comment"># protect against repeated inclusion of this file
# (replace &lt;name&gt; with a unique identifier)
</span><span class="keyword">if</span> <span class="operator">[</span> -z <span class="literal string double">&quot;${__HAVE_&lt;name&gt;__-}&quot;</span> <span class="operator">]</span>; <span class="keyword">then
</span><span class="name builtin">readonly </span>__HAVE_&lt;name&gt;__<span class="operator">=</span>y

<span class="comment"># function file body
# ...
</span>
<span class="keyword">fi</span>
</pre>
<p>Shell function files should be put into <tt class="docutils literal"><span class="pre">&lt;ADDITIONS_DIR&gt;/shlib</span></tt>.</p>
</div>
<div class="section" id="adding-a-hook-event">
<h2><a class="toc-backref" href="#contents">9.5&nbsp;&nbsp;&nbsp;Adding a hook event</a></h2>
<p>Adding a new event has to be done in <em>roverlay's</em> source code and is a rather
trivial task. The <tt class="docutils literal">roverlay.hook</tt> module implements a function for running
the event script:</p>
<pre class="code python literal-block">
<span class="comment"># import hook module</span>
<span class="keyword namespace">import</span> <span class="name namespace">roverlay.hook</span>

<span class="comment"># ...</span>
<span class="comment"># then, somewhere in the code</span>
<span class="name">roverlay</span><span class="operator">.</span><span class="name">hook</span><span class="operator">.</span><span class="name">run</span> <span class="punctuation">(</span> <span class="literal string">&quot;&lt;event&gt;&quot;</span> <span class="punctuation">)</span>
<span class="comment"># ...</span>
<span class="name">roverlay</span><span class="operator">.</span><span class="name">hook</span><span class="operator">.</span><span class="name">run</span> <span class="punctuation">(</span> <span class="literal string">&quot;&lt;another event&gt;&quot;</span> <span class="punctuation">)</span>
</pre>
</div>
</div>
<div class="section" id="configuration-reference">
<h1><a class="toc-backref" href="#contents">10&nbsp;&nbsp;&nbsp;Configuration Reference</a></h1>
<p>The main config file uses '&lt;option&gt; = &lt;value&gt;' syntax, comment lines start
with <strong>#</strong>. Variable substitution (&quot;${X}&quot;) is not supported. Quotes around
the value are optional and allow to span long values over multiple lines.
Whitespace is ignored, file <strong>paths must not contain whitespace</strong>.</p>
<p>Some options have value type restrictions. These <em>value types</em> are used:</p>
<dl class="docutils">
<dt>log_level</dt>
<dd>Value has to be a log level. Available choise are <em>DEBUG</em>, <em>INFO</em>, <em>WARN</em>,
<em>WARNING</em>, <em>ERROR</em> and <em>CRITICAL</em>.</dd>
<dt>bool</dt>
<dd><p class="first">Value is a string that represents a boolean value.</p>
<p>This table illustrates which value strings are accepted:</p>
<table border="1" class="last docutils">
<colgroup>
<col width="59%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">string value</th>
<th class="head">boolean value</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>y, yes, on, 1, true, enabled</td>
<td><em>True</em></td>
</tr>
<tr><td>n, no, off, 0, false, disabled</td>
<td><em>False</em></td>
</tr>
<tr><td><em>&lt;any other value&gt;</em></td>
<td><strong>not allowed</strong></td>
</tr>
</tbody>
</table>
</dd>
</dl>
<p>There are also some implicit <em>value types</em>:</p>
<dl class="docutils">
<dt>list</dt>
<dd>This means that a option has several values that are separated by
whitespace. Quotation marks have to be used to specify more than one
value.</dd>
<dt>file, dir</dt>
<dd>A value that represents a file system location will be expanded ('~' will
be replaced by the user's home etc.).
Additionaly the value has to be a file (or directory) if it exists.</dd>
<dt>&lt;empty&gt;</dt>
<dd>Specifying empty values often leads to errors if an option has value type
restrictions. Commenting it out is safe.</dd>
</dl>
<p>The following sections will list all config entries.</p>
<div class="section" id="misc-options">
<h2><a class="toc-backref" href="#contents">10.1&nbsp;&nbsp;&nbsp;misc options</a></h2>
<dl class="docutils" id="cachedir">
<dt>CACHEDIR</dt>
<dd><p class="first">Directory for persistent files that don't belong to the overlay, e.g.
the distmap file.</p>
<p>This option is <strong>required</strong>.</p>
<p class="last">&lt;&lt;TODO: default value!&gt;&gt;</p>
</dd>
</dl>
<dl class="docutils" id="distfiles">
<dt>DISTFILES</dt>
<dd>Alias to <a class="reference internal" href="#distfiles-root">DISTFILES_ROOT</a>.</dd>
</dl>
<dl class="docutils" id="distfiles-root">
<dt>DISTFILES_ROOT</dt>
<dd><p class="first">The root directory of per-repository package directories. Repos will create
their package directories in this directory unless they specify another
location (see <a class="reference internal" href="#repo-config-options">repo config options</a>).</p>
<p class="last">This option is <strong>required</strong>.</p>
</dd>
</dl>
<dl class="docutils" id="distroot">
<dt>DISTROOT</dt>
<dd>Alias to <a class="reference internal" href="#distfiles-root">DISTFILES_ROOT</a>.</dd>
</dl>
<dl class="docutils" id="ebuild-prog">
<dt>EBUILD_PROG</dt>
<dd><p class="first">Name or path of the ebuild executables that is required for (external)
Manifest file creation. A wrong value will cause ebuild creation to fail
late, which is a huge time loss, so make sure that this option is properly
set.</p>
<p class="last">Defaults to <em>ebuild</em>, which should be fine in most cases.</p>
</dd>
</dl>
<dl class="docutils" id="nosync">
<dt>NOSYNC</dt>
<dd><p class="first">A <em>bool</em> that controls whether <em>syncing</em>, i.e. data transfers from/to
remote machines, is allowed or forbidden.</p>
<p class="last">Defaults to <em>no</em>.</p>
</dd>
</dl>
<dl class="docutils" id="rsync-bwlimit">
<dt>RSYNC_BWLIMIT</dt>
<dd><p class="first">Set a max. average bandwidth usage in kilobytes per second.
This will pass '--bwlimit=&lt;value&gt;' to all rsync commands.</p>
<p class="last">Defaults to &lt;not set&gt;, which disables bandwidth limitation.</p>
</dd>
</dl>
</div>
<div class="section" id="overlay-options">
<h2><a class="toc-backref" href="#contents">10.2&nbsp;&nbsp;&nbsp;overlay options</a></h2>
<dl class="docutils" id="additions-dir">
<dt>ADDITIONS_DIR:</dt>
<dd>Alias to <a class="reference internal" href="#overlay-additions-dir">OVERLAY_ADDITIONS_DIR</a>.</dd>
</dl>
<dl class="docutils" id="backup-desc">
<dt>BACKUP_DESC</dt>
<dd>Alias to <a class="reference internal" href="#overlay-backup-desc">OVERLAY_BACKUP_DESC</a>.</dd>
</dl>
<dl class="docutils" id="distdir">
<dt>DISTDIR</dt>
<dd>Alias to <a class="reference internal" href="#overlay-distdir-root">OVERLAY_DISTDIR_ROOT</a>.</dd>
</dl>
<dl class="docutils" id="distdir-flat">
<dt>DISTDIR_FLAT</dt>
<dd>Alias to <a class="reference internal" href="#overlay-distdir-flat">OVERLAY_DISTDIR_FLAT</a>.</dd>
</dl>
<dl class="docutils" id="distdir-strategy">
<dt>DISTDIR_STRATEGY</dt>
<dd>Alias to <a class="reference internal" href="#overlay-distdir-strategy">OVERLAY_DISTDIR_STRATEGY</a>.</dd>
</dl>
<dl class="docutils" id="distdir-verify">
<dt>DISTDIR_VERIFY</dt>
<dd>Alias to <a class="reference internal" href="#overlay-distdir-verify">OVERLAY_DISTDIR_VERIFY</a>.</dd>
</dl>
<dl class="docutils" id="distmap-compression">
<dt>DISTMAP_COMPRESSION</dt>
<dd>Alias to <a class="reference internal" href="#overlay-distmap-compression">OVERLAY_DISTMAP_COMPRESSION</a>.</dd>
</dl>
<dl class="docutils" id="distmap-file">
<dt>DISTMAP_FILE</dt>
<dd>Alias to <a class="reference internal" href="#overlay-distmap-file">OVERLAY_DISTMAP_FILE</a>.</dd>
</dl>
<dl class="docutils" id="ebuild-use-expand-name">
<dt>EBUILD_USE_EXPAND_NAME</dt>
<dd>Name of the R_SUGGESTS USE_EXPAND variable. Defaults to <em>R_SUGGESTS</em>.</dd>
</dl>
<dl class="docutils" id="eclass">
<dt>ECLASS</dt>
<dd>Alias to <a class="reference internal" href="#overlay-eclass">OVERLAY_ECLASS</a>.</dd>
</dl>
<dl class="docutils" id="manifest-implementation">
<dt>MANIFEST_IMPLEMENTATION</dt>
<dd>Alias to <a class="reference internal" href="#overlay-manifest-implementation">OVERLAY_MANIFEST_IMPLEMENTATION</a>.</dd>
</dl>
<dl class="docutils" id="overlay-additions-dir">
<dt>OVERLAY_ADDITIONS_DIR</dt>
<dd><p class="first">Directory with an overlay-like structure that contains extra files, e.g.
ebuild patches and hand-written ebuilds. This option is not required.</p>
<p class="last">Defaults to &lt;not set&gt;, which disables this feature.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-backup-desc">
<dt>OVERLAY_BACKUP_DESC</dt>
<dd><p class="first">A <em>bool</em> that indicates whether the description file of the <em>R_SUGGESTS</em>
USE_EXPAND variable should be backed up before (over-)writing it.</p>
<p class="last">Defaults to <em>true</em>.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-category">
<dt>OVERLAY_CATEGORY</dt>
<dd><p class="first">Sets the category of created ebuilds. There are no value type restrictions
for this option, but values with a slash <em>/</em> lead to errors.</p>
<p class="last">Defaults to <em>sci-R</em>.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-dir">
<dt>OVERLAY_DIR</dt>
<dd><p class="first">Sets the directory of the overlay that will be created.</p>
<p class="last">This option is <strong>required</strong>.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-distdir-flat">
<dt>OVERLAY_DISTDIR_FLAT</dt>
<dd><p class="first">A <em>bool</em> that controls the overall layout of <a class="reference internal" href="#overlay-distdir-root">OVERLAY_DISTDIR_ROOT</a>.</p>
<p>A flat distdir is a single directory with all package files or package
file links in it. A nested distdir contains per-package directories.</p>
<p class="last">Defaults to <em>true</em>.
This option has no effect if the distdir strategy is <em>tmpdir</em>.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-distdir-root">
<dt>OVERLAY_DISTDIR_ROOT</dt>
<dd><p class="first">Sets the DISTDIR root directory. It is used for Manifest file
creation, but can serve as package mirror directory as well.</p>
<p>The actual appearance of this directory is up to the distdir strategy
(<a class="reference internal" href="#overlay-distdir-strategy">OVERLAY_DISTDIR_STRATEGY</a>) and <a class="reference internal" href="#overlay-distdir-flat">OVERLAY_DISTDIR_FLAT</a>.
Basically, it contains all package files that have a valid ebuild.</p>
<div class="note last">
<p class="first admonition-title">Note</p>
<p class="last">This directory will not be cleaned up, only broken symbolic links
will be removed. On the one hand, it is absolutely guaranteed that
package files will not disappear unless replaced by a new file with
the same name, but on the other hand, the directory may get bloated
over time.</p>
</div>
</dd>
</dl>
<dl class="docutils" id="overlay-distdir-strategy">
<dt>OVERLAY_DISTDIR_STRATEGY</dt>
<dd><p class="first">The distdir strategy defines <em>how</em> package files are created.
It is a list of methods that will be tried in the specified order, until
the first one succeeds.</p>
<table border="1" class="docutils">
<caption>distdir creation methods</caption>
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">method</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>symlink</td>
<td>use symbolic links</td>
</tr>
<tr><td>hardlink</td>
<td>use hard links</td>
</tr>
<tr><td>copy</td>
<td>copy package files
Obviously, this will need much more disk space.</td>
</tr>
<tr><td>tmpdir</td>
<td>use a temporary DISTDIR that will be deleted at exit.
This method is not compatible with any of the above.</td>
</tr>
</tbody>
</table>
<p class="last">This option is <strong>required</strong>, but has a reasonable value in the default
config file, &quot;hardlink symlink&quot;.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-distdir-verify">
<dt>OVERLAY_DISTDIR_VERIFY</dt>
<dd><p class="first">A <em>bool</em> that controls whether file integrity of <em>OVERLAY_DISTDIR_ROOT</em>
should be checked on startup. This is an expensive operation since each
file have to be read once.</p>
<p class="last">Defaults to <em>no</em> as the verification is normally not needed.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-distmap-compression">
<dt>OVERLAY_DISTMAP_COMPRESSION</dt>
<dd><p class="first">Compression format for the distmap file. Choices are none, gzip/gz and
bzip2/bz2.</p>
<p class="last">Defaults to bzip2.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-distmap-file">
<dt>OVERLAY_DISTMAP_FILE:</dt>
<dd><p class="first">File path to the distmap file.</p>
<p class="last">Defaults to &lt;not set&gt;, which results in <a class="reference internal" href="#cachedir">CACHEDIR</a>/distmap.db.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-eclass">
<dt>OVERLAY_ECLASS</dt>
<dd><p class="first">A list of eclass files that will be imported into the overlay and inherited
in all created ebuilds.
Note that overlay creation fails if any of the specified eclass files
cannot be imported.
Eclass files must end with '.eclass' or have no file extension.</p>
<p class="last">Defaults to &lt;not set&gt;, which means that no eclass files will be used.
This is <strong>not useful</strong>, since created ebuilds rely on an eclass for phase
functions like <em>src_install()</em>.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-keep-nth-latest">
<dt>OVERLAY_KEEP_NTH_LATEST</dt>
<dd><p class="first">Setting this option to a value &gt; 0 enables keeping of max. <em>value</em> ebuilds
per R package. All others will be removed.</p>
<p class="last">Defaults to &lt;not set&gt;, which disables this feature and keeps all ebuilds.</p>
</dd>
</dl>
<dl class="docutils" id="overlay-manifest-implementation">
<dt>OVERLAY_MANIFEST_IMPLEMENTATION</dt>
<dd><p class="first">Sets the implementation that will be used for Manifest file writing.
Available choices are <em>ebuild</em>, <em>portage</em>, <em>default</em> and <em>none</em>.
Defaults to <em>default</em> (-&gt; <em>ebuild</em>).
<em>portage</em> is highly experimental and therefore not recommended
for production usage.</p>
<div class="note last">
<p class="first admonition-title">Note</p>
<p class="last">Choosing 'none' is destructive - <em>roverlay</em> will fail to function
whenever Manifest access is required.
Use the '--no-manifest' command line option to disable manifest
writing.</p>
</div>
</dd>
</dl>
<dl class="docutils" id="overlay-name">
<dt>OVERLAY_NAME</dt>
<dd><p class="first">Sets the name of the created overlay that will be written into
<em>OVERLAY_DIR/profiles/repo_name</em>. This file will be rewritten on every
<em>roverlay</em> run that includes the <em>create</em> command.</p>
<p class="last">Defaults to <em>R_Overlay</em>.</p>
</dd>
</dl>
<dl class="docutils" id="use-expand-name">
<dt>USE_EXPAND_NAME:</dt>
<dd>Alias to <a class="reference internal" href="#ebuild-use-expand-name">EBUILD_USE_EXPAND_NAME</a>.</dd>
</dl>
</div>
<div class="section" id="other-config-files">
<h2><a class="toc-backref" href="#contents">10.3&nbsp;&nbsp;&nbsp;other config files</a></h2>
<p>Some config config options are split from the main config file for various
reasons:</p>
<ul class="simple">
<li>no need for modification in most cases, e.g. the <a class="reference internal" href="#id4">field definition</a> file</li>
<li>special syntax that is not compatible with the main config file,
e.g. the <a class="reference internal" href="#dependency-rule-file-syntax">dependency rule file syntax</a></li>
</ul>
<p>The paths to these files have to be listed in the main config file and
can be overridden with the appropriate command line options.</p>
<dl class="docutils" id="ebuild-use-expand-desc">
<dt>EBUILD_USE_EXPAND_DESC</dt>
<dd><p class="first">Path to a flag description file (for the <em>R_SUGGESTS</em> USE_EXPAND variable).
The syntax of this file is identical to USE_EXPAND description files
(<tt class="docutils literal">&lt;overlay <span class="pre">root&gt;/profiles/desc/r_suggests.desc</span></tt>).</p>
<p class="last">Defaults to &lt;not set&gt;, which disables this option.</p>
</dd>
</dl>
<dl class="docutils" id="ebuild-use-expand-rename">
<dt>EBUILD_USE_EXPAND_RENAME</dt>
<dd>Path to a file that lists alternative names for a flag in the <em>R_SUGGESTS</em>
USE_EXPAND variable.</dd>
</dl>
<dl class="docutils" id="field-definition">
<dt>FIELD_DEFINITION</dt>
<dd><p class="first">Path to the field definition file that controls how the <em>DESCRIPTION</em> file
of R packages is read.</p>
<p class="last">This option is <strong>required</strong>.</p>
</dd>
</dl>
<dl class="docutils" id="field-definition-file">
<dt>FIELD_DEFINITION_FILE</dt>
<dd>Alias to <a class="reference internal" href="#field-definition">FIELD_DEFINITION</a>.</dd>
</dl>
<dl class="docutils" id="id1">
<dt>PACKAGE_RULES</dt>
<dd>Alias to <a class="reference internal" href="#package-rule-files">PACKAGE_RULE_FILES</a>.</dd>
</dl>
<dl class="docutils" id="package-rule-files">
<dt>PACKAGE_RULE_FILES</dt>
<dd>A list of files and directories with package rules.
Directories will be recursively scanned for rule files.</dd>
</dl>
<dl class="docutils" id="id2">
<dt>REPO_CONFIG</dt>
<dd><p class="first">A list of one or more repo config files.</p>
<p class="last">This option is <strong>required</strong>.</p>
</dd>
</dl>
<dl class="docutils" id="repo-config-file">
<dt>REPO_CONFIG_FILE</dt>
<dd>Alias to <a class="reference internal" href="#id2">REPO_CONFIG</a>.</dd>
</dl>
<dl class="docutils" id="repo-config-files">
<dt>REPO_CONFIG_FILES</dt>
<dd>Alias to <a class="reference internal" href="#id2">REPO_CONFIG</a>.</dd>
</dl>
<dl class="docutils" id="simple-rules-file">
<dt>SIMPLE_RULES_FILE</dt>
<dd><p class="first">A list of files and directories with dependency rules.
Directories will be non-recursively scanned for rule files.</p>
<p class="last">This option is <strong>not required, but recommended</strong> since <em>roverlay</em> cannot do
much without dependency resolution.</p>
</dd>
</dl>
<dl class="docutils" id="simple-rules-files">
<dt>SIMPLE_RULES_FILES</dt>
<dd>Alias to <a class="reference internal" href="#simple-rules-file">SIMPLE_RULES_FILE</a>.</dd>
</dl>
<dl class="docutils" id="use-expand-desc">
<dt>USE_EXPAND_DESC</dt>
<dd>Alias to <a class="reference internal" href="#ebuild-use-expand-desc">EBUILD_USE_EXPAND_DESC</a>.</dd>
</dl>
<dl class="docutils" id="use-expand-rename">
<dt>USE_EXPAND_RENAME</dt>
<dd>Alias to <a class="reference internal" href="#ebuild-use-expand-rename">EBUILD_USE_EXPAND_RENAME</a>.</dd>
</dl>
</div>
<div class="section" id="shell-environment-hooks">
<h2><a class="toc-backref" href="#contents">10.4&nbsp;&nbsp;&nbsp;shell environment / hooks</a></h2>
<dl class="docutils" id="event-hook">
<dt>EVENT_HOOK</dt>
<dd><p class="first">A script that is called for handling <em>events</em> (see <a class="reference internal" href="#event-hooks">Event Hooks</a>).</p>
<p class="last">Defaults to &lt;libexec dir&gt;/hooks/mux.sh if roverlay has been installed
and <a class="reference internal" href="#additions-dir">ADDITIONS_DIR</a>/hooks/mux.sh otherwise.</p>
</dd>
</dl>
<dl class="docutils" id="event-hook-restrict">
<dt>EVENT_HOOK_RESTRICT</dt>
<dd><p class="first">A list of <em>events</em> that are allowed (<tt class="docutils literal">&lt;event&gt;</tt>, <tt class="docutils literal">+&lt;event&gt;</tt>) or
forbidden (<tt class="docutils literal"><span class="pre">-&lt;event&gt;</span></tt>). The asterisk wildcard character can be used to
set the default policy to <em>allow unless forbidden</em> (<tt class="docutils literal">*</tt>) or
<em>deny unless allowed</em> (<tt class="docutils literal"><span class="pre">-*</span></tt>).</p>
<p>Defaults to &lt;not set&gt;, which is equivalent to <em>deny all</em>.</p>
<p class="last"><tt class="docutils literal"><span class="pre">EVENT_HOOK_RESTRICT=&quot;overlay_success&quot;</span></tt> would allow the <tt class="docutils literal">overlay_success</tt>
event only, whereas <tt class="docutils literal"><span class="pre">EVENT_HOOK_RESTRICT=&quot;*</span> <span class="pre">-overlay_success&quot;</span></tt> would
allow any event except for <tt class="docutils literal">overlay_success</tt>. Also see <a class="reference internal" href="#event-policy">event policy</a>.</p>
</dd>
</dl>
<dl class="docutils" id="filter-shell-env">
<dt>FILTER_SHELL_ENV</dt>
<dd><p class="first">A <em>bool</em> that controls whether the hook environment should be filtered
or not.</p>
<p class="last">Defaults to <em>true</em>.</p>
</dd>
</dl>
<dl class="docutils" id="hook">
<dt>HOOK</dt>
<dd>Alias to <a class="reference internal" href="#event-hook">EVENT_HOOK</a>.</dd>
</dl>
<dl class="docutils" id="hook-restrict">
<dt>HOOK_RESTRICT</dt>
<dd>Alias to <a class="reference internal" href="#event-hook-restrict">EVENT_HOOK_RESTRICT</a>.</dd>
</dl>
</div>
<div class="section" id="logging">
<h2><a class="toc-backref" href="#contents">10.5&nbsp;&nbsp;&nbsp;logging</a></h2>
<dl class="docutils" id="log-date-format">
<dt>LOG_DATE_FORMAT</dt>
<dd><p class="first">The date format (ISO8601) used in log messages.</p>
<p class="last">Defaults to <em>%F %H:%M:%S</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-enabled">
<dt>LOG_ENABLED</dt>
<dd><p class="first">Globally enable or disable logging. The value has to be a <em>bool</em>.
Setting this option to <em>True</em> allows logging to occur, while <em>False</em>
disables logging entirely.
Log target such as <em>console</em> or <em>file</em> have to be enabled
to actually get any log messages.</p>
<p class="last">Defaults to <em>True</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-level">
<dt>LOG_LEVEL</dt>
<dd><p class="first">Sets the default log level. Log targets will use this value unless they
have  their own log level.</p>
<p class="last">Defaults to &lt;not set&gt; - all log targets will use their own defaults</p>
</dd>
</dl>
<div class="section" id="console-logging">
<h3><a class="toc-backref" href="#contents">10.5.1&nbsp;&nbsp;&nbsp;console logging</a></h3>
<dl class="docutils" id="log-console">
<dt>LOG_CONSOLE</dt>
<dd><p class="first">Enables/Disables logging to console. The value has to be a <em>bool</em>.</p>
<p class="last">Defaults to <em>True</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-format-console">
<dt>LOG_FORMAT_CONSOLE</dt>
<dd><p class="first">Sets the format for console log messages.</p>
<p class="last">Defaults to <em>%(levelname)-8s %(name)-14s: %(message)s</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-level-console">
<dt>LOG_LEVEL_CONSOLE</dt>
<dd><p class="first">Sets the log level for console logging.</p>
<p class="last">Defaults to <em>INFO</em>.</p>
</dd>
</dl>
</div>
<div class="section" id="file-logging">
<h3><a class="toc-backref" href="#contents">10.5.2&nbsp;&nbsp;&nbsp;file logging</a></h3>
<dl class="docutils" id="log-file">
<dt>LOG_FILE</dt>
<dd><p class="first">Sets the log file. File logging will be disabled if this option does not
exist or is commented out even if <a class="reference internal" href="#log-file-enabled">LOG_FILE_ENABLED</a> is set to <em>True</em>.</p>
<p class="last">Defaults to &lt;not set&gt;.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-buffered">
<dt>LOG_FILE_BUFFERED</dt>
<dd><p class="first">Enable/Disable buffering of log entries in memory before they are written
to the log file. Enabling this reduces I/O blocking, especially when using
low log levels. The value must be a <em>bool</em>.</p>
<p class="last">Defaults to enabled.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-buffer-count">
<dt>LOG_FILE_BUFFER_COUNT</dt>
<dd><p class="first">Sets the number of log entries to buffer at most. Can be decreased to
lower memory consumption when using log entry buffering.</p>
<p class="last">Defaults to <em>250</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-enabled">
<dt>LOG_FILE_ENABLED</dt>
<dd><p class="first">Enables/Disable file logging. The value has to be a bool.</p>
<p class="last">Defaults to enabled, in which case file logging is enabled if <a class="reference internal" href="#log-file">LOG_FILE</a>
is set, else disabled.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-format">
<dt>LOG_FILE_FORMAT</dt>
<dd><p class="first">Sets the format used for log messages written to a file.</p>
<p class="last">Defaults to <em>%(asctime)s %(levelname)-8s %(name)-10s: %(message)s</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-level">
<dt>LOG_FILE_LEVEL</dt>
<dd><p class="first">Sets the log level for file logging.</p>
<p class="last">Defaults to <em>WARNING</em>.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-rotate">
<dt>LOG_FILE_ROTATE</dt>
<dd><p class="first">A <em>bool</em> that enables/disables log file rotation. If enabled, the log file
will be rotated on every script run and max. <a class="reference internal" href="#log-file-rotate-count">LOG_FILE_ROTATE_COUNT</a> log
files will be kept.</p>
<p class="last">Defaults to disabled.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-rotate-count">
<dt>LOG_FILE_ROTATE_COUNT</dt>
<dd><p class="first">Sets the number of log files to keep at most.</p>
<p class="last">Defaults to <em>3</em> and has no effect if <a class="reference internal" href="#log-file-rotate">LOG_FILE_ROTATE</a> is disabled.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="options-for-debugging-manual-dependency-rule-creation-and-testing">
<h2><a class="toc-backref" href="#contents">10.6&nbsp;&nbsp;&nbsp;options for debugging, manual dependency rule creation and testing</a></h2>
<dl class="docutils" id="description-dir">
<dt>DESCRIPTION_DIR</dt>
<dd><p class="first">A directory where all description data read from an R package will be
written into. This can be used to analyze/backtrack overlay creation
results.</p>
<p class="last">Defaults to &lt;not set&gt;, which disables writing of description data files.</p>
</dd>
</dl>
<dl class="docutils" id="log-file-unresolvable">
<dt>LOG_FILE_UNRESOLVABLE</dt>
<dd><p class="first">A file where all unresolved dependency strings will be written into
on <em>roverlay</em> exit. Primarily useful for creating new rules.</p>
<p class="last">Defaults to &lt;not set&gt;, which disables this feature.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="id3">
<h1><a class="toc-backref" href="#contents">11&nbsp;&nbsp;&nbsp;Other config files</a></h1>
<div class="section" id="use-expand-flag-rename-file">
<h2><a class="toc-backref" href="#contents">11.1&nbsp;&nbsp;&nbsp;USE_EXPAND flag rename file</a></h2>
<p>The <a class="reference internal" href="#use-expand-rename">USE_EXPAND_RENAME</a> file contains dictionary-like entries that assign
<em>effective</em> flag names to flag names generated at runtime.</p>
<p>The syntax is as follows:</p>
<pre class="code text literal-block">
# comments start with '#'

&lt;effective flag&gt; &lt;runtime flag&gt; [&lt;another runtime flag&gt;...]

# a '=' can be used as separator to improve readability
&lt;effective flag&gt; = &lt;runtime flag&gt; [&lt;another runtime flag&gt;...]

# the previous line can be continued with leading whitespace
&lt;effective flag&gt; = &lt;runtime flag&gt;
   [&lt;another runtime flag&gt;...]
</pre>
<p>Example:</p>
<pre class="code text literal-block">
# rename 'audio' and 'snd' to 'sound'
sound = audio snd
</pre>
<p>Each flag is renamed at most once, so the following example renames 'sound'
to media, but 'audio' to 'sound':;</p>
<pre class="code text literal-block">
sound = audio snd
media = sound video
</pre>
<div class="caution">
<p class="first admonition-title">Caution!</p>
<p class="last">Assigning more than one <em>effective flag</em> to a <em>runtime flag</em> leads to
unpredictable results.</p>
</div>
</div>
<div class="section" id="field-definition-config">
<span id="id4"></span><h2><a class="toc-backref" href="#contents">11.2&nbsp;&nbsp;&nbsp;Field Definition Config</a></h2>
<p>The field definition file uses <a class="reference external" href="http://docs.python.org/library/configparser.html">ConfigParser</a> syntax and defines
how an R package's DESCRIPTION file is read.
See the next section, <a class="reference internal" href="#default-field-definition-file">default field definition file</a>,  for an example.</p>
<p>Each information field has its own section which declares a set of options
and flags. Flags are case-insensitive options without a value - they are
enabled by listing them.</p>
<p id="field-options"><span id="field-option"></span>Available field options:</p>
<blockquote>
<dl class="docutils" id="field-option-default-value">
<dt>default_value</dt>
<dd>Sets the default value for a field, which implies that any read
DESCRIPTION file will contain this field, either with the value read
from the file or (as fallback) the default value.
Disables the <a class="reference internal" href="#mandatory-field-flag">'mandatory' field flag</a>.</dd>
</dl>
<dl class="docutils" id="field-option-allowed-value">
<dt>allowed_value</dt>
<dd>Declares that a field has a value whitelist and adds the value to that
list (preserves whitespace).</dd>
</dl>
<dl class="docutils" id="field-option-allowed-values">
<dt>allowed_values</dt>
<dd>Declares that a field has a value whitelist and adds the values to
that list (values are separated by whitespace).</dd>
</dl>
<dl class="docutils" id="field-option-alias">
<span id="field-option-alias-withcase"></span><dt>alias_withcase, alias</dt>
<dd>Declares case-sensitive field name aliases. This can be used to fix
'typos', e.g. <em>Suggest</em> and <em>Suggests</em> both mean <em>Suggests</em>.</dd>
</dl>
<dl class="docutils" id="field-option-alias-nocase">
<dt>alias_nocase</dt>
<dd>Same as <a class="reference internal" href="#field-option-alias">field option: alias</a>, but the listed aliases are
case-insensitive.</dd>
</dl>
<dl class="docutils" id="field-option-flags">
<dt>flags</dt>
<dd>List of <a class="reference internal" href="#field-flags">field flags</a>. Note that any option without a value is treated
as flag.</dd>
</dl>
</blockquote>
<p id="field-flag"><span id="field-flags"></span>Known field flags:</p>
<blockquote>
<dl class="docutils" id="field-flag-joinvalues">
<dt>joinValues</dt>
<dd>Declares that a field's value is one string even if it spans over
multiple lines.
The lines will be joined with a single space character ' '.
The default behavior is to merge lines.</dd>
</dl>
<dl class="docutils" id="field-flag-islist">
<dt>isList</dt>
<dd>Declares that a field's value is a list whose values are separated
by ',' and/or ';'.</dd>
</dl>
<dl class="docutils" id="field-flag-iswhitespacelist">
<dt>isWhitespaceList</dt>
<dd>Declares that a field's value is a list whose values are separated by
whitespace. Has no effect if <cite>field flag: isList</cite> is set.</dd>
</dl>
<dl class="docutils" id="mandatory-field-flag">
<span id="field-flag-mandatory"></span><dt>mandatory</dt>
<dd>Declares that a field is required in <em>all</em> DESCRIPTION files.
This means that R packages without that field are considered as unusable,
i.e. ebuild creation fails early.
This flag is (effectively) useless in conjunction with
<a class="reference internal" href="#field-option-default-value">field option: default_value</a> unless the default value evaluates to
False (e.g. is an empty string).</dd>
</dl>
<dl class="docutils" id="field-flag-ignore">
<dt>ignore</dt>
<dd>Declares that a field is known but entirely ignored. Unknown fields
are ignored, too, the main difference is the emitted log message if
such a field is found.</dd>
</dl>
</blockquote>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">It is not checked whether a flag is known or not.</p>
</div>
<div class="section" id="example-the-default-field-definition-file">
<span id="default-field-definition-file"></span><h3><a class="toc-backref" href="#contents">11.2.1&nbsp;&nbsp;&nbsp;Example: The default field definition file</a></h3>
<p>This is the default field definition file (without any ignored fields):</p>
<pre class="code ini literal-block">
<span class="keyword">[Description]</span>
<span class="error">joinValues</span>

<span class="keyword">[Title]</span>
<span class="error">joinValues</span>

<span class="keyword">[Suggests]</span>
<span class="name attribute">alias_nocase</span> <span class="operator">=</span> <span class="literal string">Suggests, Suggest, %Suggests, Suggets, Recommends</span>
<span class="error">isList</span>

<span class="keyword">[Depends]</span>
<span class="name attribute">alias_nocase</span> <span class="operator">=</span> <span class="literal string">Depends, Dependencies, Dependes, %Depends, Depents, Require, Requires</span>
<span class="error">isList</span>

<span class="keyword">[Imports]</span>
<span class="name attribute">alias_nocase</span> <span class="operator">=</span> <span class="literal string">Imports, Import</span>
<span class="error">isList</span>

<span class="keyword">[LinkingTo]</span>
<span class="name attribute">alias_nocase</span> <span class="operator">=</span> <span class="literal string">LinkingTo, LinkingdTo, LinkinTo</span>
<span class="error">isList</span>

<span class="keyword">[SystemRequirements]</span>
<span class="name attribute">alias_nocase</span> <span class="operator">=</span> <span class="literal string">SystemRequirements, SystemRequirement</span>
<span class="error">isList</span>

<span class="keyword">[OS_Type]</span>
<span class="name attribute">alias_nocase</span>   <span class="operator">=</span> <span class="literal string">OS_TYPE</span>
<span class="name attribute">allowed_values</span> <span class="operator">=</span> <span class="literal string">unix</span>
</pre>
</div>
</div>
</div>
<div class="section" id="dependency-resolution-console">
<span id="depres-console"></span><h1><a class="toc-backref" href="#contents">12&nbsp;&nbsp;&nbsp;Dependency Resolution Console</a></h1>
<p>As previously stated, the <em>DepRes Console</em> is only meant for <strong>testing</strong>.
It is an interactive console with the following features:</p>
<ul class="simple">
<li>resolve dependencies</li>
<li>create new dependency rules (<strong>only single line rules</strong>)</li>
<li>create dependency rules for each R package found in a directory</li>
<li>load rules from files</li>
<li>save rules to a file</li>
</ul>
<p>Rules are managed in a set. These so-called <em>rule pools</em> are organized in
a <em>first-in-first-out</em> data structure that allows
to create or remove them easily at runtime.</p>
<p>Running <tt class="docutils literal">roverlay depres_console</tt> will print a welcome message that
lists all available commands and a few usage hints.</p>
<p>For reference, these commands are currently available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">command</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>help,
h</td>
<td>lists all commands</td>
</tr>
<tr><td>help --list,
h --list</td>
<td>lists all help topics for which help is available</td>
</tr>
<tr><td>help <em>&lt;cmd&gt;</em>,
h <em>&lt;cmd&gt;</em></td>
<td>prints a command-specific help message</td>
</tr>
<tr><td>load <em>&lt;file|dir&gt;</em>,
l <em>&lt;file|dir&gt;</em></td>
<td>loads a rule file or a directory with rule files
into a new <em>rule pool</em></td>
</tr>
<tr><td>load_conf,
lc</td>
<td>loads the rule files listed in the config file
into a new <em>rule pool</em></td>
</tr>
<tr><td>addrule <em>&lt;rule&gt;</em>
+ <em>&lt;rule&gt;</em></td>
<td>creates a new rule and adds it to the topmost,
i.e. latest <em>rule pool</em>. This command uses
<a class="reference internal" href="#rule-file-syntax">Rule File Syntax</a>, but multi line rules are
not supported.</td>
</tr>
<tr><td>add_pool,
&lt;&lt;</td>
<td>creates a new <em>rule pool</em></td>
</tr>
<tr><td>unwind,
&gt;&gt;</td>
<td>removes the topmost <em>rule pool</em> and all of its
rules</td>
</tr>
<tr><td>resolve <em>&lt;dep&gt;</em>,
? <em>&lt;dep&gt;</em></td>
<td>tries to resolve the given dependency string and
prints the result</td>
</tr>
<tr><td>print, p</td>
<td>prints the rules of the topmost <em>rule pool</em></td>
</tr>
<tr><td>print all, p all</td>
<td>prints the rules of all <em>rule pools</em></td>
</tr>
<tr><td>write <em>&lt;file&gt;</em>,
w <em>&lt;file&gt;</em></td>
<td>writes the rules of the topmost <em>rule pool</em> into
<em>&lt;file&gt;</em></td>
</tr>
<tr><td>cd <em>&lt;dir&gt;</em></td>
<td>changes the working directory, also creates it if
necessary</td>
</tr>
<tr><td>scandir <em>&lt;dir&gt;</em>,
sd <em>&lt;dir&gt;</em></td>
<td>creates dependency rules for each R package found
in <em>&lt;dir&gt;</em></td>
</tr>
<tr><td>set, unset</td>
<td>prints the status of currently (in)active modes</td>
</tr>
<tr><td>set <em>&lt;mode&gt;</em>,
unset <em>&lt;mode&gt;</em></td>
<td>sets or unsets <em>&lt;mode&gt;</em>. There is only one mode to
control, the <em>shlex mode</em> which controls how
command arguments are parsed</td>
</tr>
<tr><td>mkhelp</td>
<td>verifies that each accessible command has a help
message</td>
</tr>
<tr><td>exit, qq, q</td>
<td>exits the <em>DepRes Console</em></td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt>Example Session:</dt>
<dd><pre class="code first last literal-block">
== depres console ==
Run 'help' to list all known commands
More specifically, 'help &lt;cmd&gt;' prints a help message for the given
command, and 'help --list' lists all help topics available
Use 'load_conf' or 'lc' to load the configured rule files

commands: load, unwind, set, help, &gt;&gt;, load_conf, &lt;&lt;, cd, mkhelp,
resolve, lc, add_pool, addrule, h, +, l, li, write, p, r, ?, w, print,
sd, unset, scandir
exit-commands: q, qq, exit

cmd % + ~dev-lang/R :: R language
new rules:
~dev-lang/R :: R language
--- ---
command succeeded.

cmd % ? R language
Trying to resolve ('R language',).
Resolved as: ('dev-lang/R',)

cmd % ? R language [ 2.15 ]
Trying to resolve ('R language [ 2.15 ]',).
Resolved as: ('&gt;=dev-lang/R-2.15',)

cmd % ? R
Trying to resolve ('R',).
Channel returned None. At least one dep could not be resolved.

cmd % p
~dev-lang/R :: R language

cmd % &gt;&gt;
Pool removed from resolver.

cmd % p

cmd % ? R language
Trying to resolve ('R language',).
Channel returned None. At least one dep could not be resolved.

cmd % exit
</pre>
</dd>
</dl>
</div>
<div class="section" id="implementation-overview">
<h1><a class="toc-backref" href="#contents">13&nbsp;&nbsp;&nbsp;Implementation Overview</a></h1>
<p>This chapter gives an in-depth overview of how roverlay works.
Code documentation is also available and html pages for it can be created
with <tt class="docutils literal">make pydoc</tt> in the <em>R Overlay src directory</em> or by using pydoc
directly.</p>
<div class="section" id="packageinfo">
<h2><a class="toc-backref" href="#contents">13.1&nbsp;&nbsp;&nbsp;PackageInfo</a></h2>
<p><em>PackageInfo</em> is the data object that contains all information about an
R package and is created by the owning repository.</p>
<p>After initialization it contains data like</p>
<ul class="simple">
<li>the path to the R package file</li>
<li>the origin (repository)</li>
<li>the SRC_URI</li>
<li>the package name, version</li>
</ul>
<p>Not all of these are really existent, some are calculated. <em>SRC_URI</em>,
for example, can often be calculated by combining the origin's &quot;root&quot; src uri
with the package file.</p>
<p>Initialization may fail if the package's name cannot be understood, which is
most likely due to unsupported versioning schemes.</p>
<p>It is then checked whether the newly created <em>PackageInfo p</em> can be part of
the overlay. The overlay may refuse to accept <em>p</em> if an ebuild already exists
for it. Otherwise, <em>p</em> is now part of the overlay and has to pass
<em>ebuild creation</em>.</p>
</div>
<div class="section" id="repository-management">
<h2><a class="toc-backref" href="#contents">13.2&nbsp;&nbsp;&nbsp;Repository Management</a></h2>
<p>Repositories are managed in a list-like object, <em>RepoList</em>. Its task is to
provide R package input for overlay creation and implements the following
functionality:</p>
<ul class="simple">
<li>load repository config from file(s)</li>
<li>directly add a directory as <em>local repository</em></li>
<li><em>sync</em> all repos and <em>nosync</em> all repos (offline mode)</li>
<li>create <em>PackageInfo</em> instances for R packages from all repositories</li>
</ul>
<div class="section" id="repository">
<h3><a class="toc-backref" href="#contents">13.2.1&nbsp;&nbsp;&nbsp;Repository</a></h3>
<p>The functionality described above is an abstraction layer that calls the
respective function for each repository and collects the result.
So, while the <em>RepoList</em> object knows <em>what</em> to do for all repositories,
a repository object <em>repo</em> extends this by:</p>
<ul>
<li><p class="first">data</p>
<blockquote>
<ul>
<li><p class="first">repository <em>type</em></p>
</li>
<li><p class="first">filesystem directory <em>distdir</em> where <em>repo</em>'s R packages are stored</p>
</li>
<li><p class="first">the <em>root src_uri</em>, which is used to determine the <em>SRC_URI</em> ebuild
variable for all packages from <em>repo</em>:</p>
<p><em>SRC_URI</em> = <em>root src_uri</em> + '/' + &lt;path of R package relative to <em>distdir</em>&gt;</p>
</li>
<li><p class="first">other data like the sync status, repository name</p>
</li>
</ul>
</blockquote>
</li>
<li><p class="first">functionality</p>
<blockquote>
<ul class="simple">
<li>sync/nosync</li>
<li>create <em>PackageInfo</em> instances for all packages from <em>repo</em></li>
<li>status indicators, e.g. if sync was successful</li>
</ul>
</blockquote>
</li>
</ul>
<p>The actual functionality depends on the <em>repository type</em>, i.e. the
implementing class. The most basic implementation that provides all common
data, status indicator functions and <em>PackageInfo</em> creation is called
<em>BasicRepo</em>. It also implements a rather abstract sync function that calls
subclass-specifc <em>_sync()</em>/<em>_nosync()</em> functions if available.
<em>BasicRepos</em> are used to realize <em>local repositories</em>. The other available
repository types, <em>rsync</em>, <em>websync_repo</em> and <em>websync_pkglist</em> derive from
<em>BasicRepo</em>.</p>
<div class="section" id="adding-new-repository-types">
<h4><a class="toc-backref" href="#contents">13.2.1.1&nbsp;&nbsp;&nbsp;Adding new repository types</a></h4>
<p>Adding new repository types is best done by creating a new repo class
that inherits <em>BasicRepo</em>. The table below shows <em>BasicRepo</em>'s subclass
awareness concerning <em>sync()</em> and what may be changed if required.
Most repository types want to define their own sync functionality and
can do so by implementing <em>_dosync()</em>:</p>
<table border="1" class="docutils">
<caption>deriving repository types from BasicRepo</caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">function/method</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>_dosync()</td>
<td>sync packages using a remote, has to return True/False</td>
</tr>
<tr><td>_nosync()</td>
<td>sync packages in offline mode (returns True/False)</td>
</tr>
<tr><td>sync (<em>online?</em>)</td>
<td>implemented by <em>BasicRepo</em>, calls _dosync()/_nosync()
if available, else checks whether <em>distdir</em> exists</td>
</tr>
<tr><td>scan_distdir(...)</td>
<td><em>BasicRepo</em>: creates <em>PackageInfo</em> instances for all
R packages in <em>distdir</em>. Derived classes can override
this e.g. if they want to expose only synced packages</td>
</tr>
<tr><td>ready()</td>
<td>tells whether _dosync()/_nosync() was successful,
used by <em>RepoList</em> to decide whether to call
scan_distdir() or not. Properly implemented by
<em>BasicRepo</em> when using its sync() method, else needs
to be overridden.</td>
</tr>
<tr><td>__init__()</td>
<td>has to be implemented if the new class has additional
data. Refer to in-code documentation and examples.</td>
</tr>
</tbody>
</table>
<p>The <em>RsyncRepo</em>, for example, extends <em>BasicRepo</em> by rsync-specific data, e.g.
the uri used for rsync, and has its own <em>__init__()</em> method. It also
implements <em>_dosync()</em>, which calls the <em>rsync</em> executable in a filtered
environment that contains only variables like USER, PATH and RSYNC_PROXY.
The other available repository types have an internal-only implementation:</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="28%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">repository type</th>
<th class="head">repository class</th>
<th class="head">_dosync() implementation</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>local</td>
<td>BasicRepo</td>
<td><em>not applicable</em></td>
</tr>
<tr><td>rsync</td>
<td>RsyncRepo</td>
<td><strong>external</strong>, using <em>rsync</em> in
a filtered environment</td>
</tr>
<tr><td>websync_repo
websync_pkglist</td>
<td>WebsyncRepo
WebsyncPackageList</td>
<td>internal, using <em>urllib</em></td>
</tr>
</tbody>
</table>
<p>Repository types also need an entry in the repository config loader in order
to be accessible.</p>
</div>
</div>
</div>
<div class="section" id="overlay">
<h2><a class="toc-backref" href="#contents">13.3&nbsp;&nbsp;&nbsp;Overlay</a></h2>
<p>The <em>overlay</em> is roverlay's central data structure that represents a <em>portage
overlay</em>. It is organized in a tree structure (overlay root, categories,
package directories) and implements all overlay-related functionality:</p>
<ul>
<li><p class="first">Scan the <em>portage overlay</em> for existing ebuilds</p>
</li>
<li><p class="first">Add <em>PackageInfo</em> objects to the overlay. Packages can be declined if
they already exist as ebuild (incremental overlay).
Adding multiple packages at once is <strong>thread-safe</strong>, but overlay writing
is not.</p>
</li>
<li><p class="first">List all known packages (filesystem and runtime/memory)</p>
</li>
<li><p class="first">Write the overlay to its filesystem location</p>
<blockquote>
<ul class="simple">
<li>initialize the overlay (write the <em>profiles/</em> directory,
import eclass files)</li>
<li>Write ebuilds; all <em>PackageInfo</em> instances with an ebuild will be written</li>
<li>Generate and write metadata</li>
<li>Write Manifest files</li>
</ul>
</blockquote>
</li>
<li><p class="first">Features like <a class="reference internal" href="#overlay-keep-nth-latest">OVERLAY_KEEP_NTH_LATEST</a> make use of ebuild deletion,
but unconditional ebuild deletion is only available on the package directory
level</p>
</li>
</ul>
<div class="section" id="metadata-creation">
<h3><a class="toc-backref" href="#contents">13.3.1&nbsp;&nbsp;&nbsp;Metadata Creation</a></h3>
<p><em>metadata.xml</em> files are created with a tree structure that contains <em>metadata
nodes</em>, e.g. '&lt;pkgmetadata&gt;...&lt;/pkgmetadata&gt;' and '&lt;use&gt;...&lt;/use&gt;' are <em>nodes</em>.
The current implementation writes the R package's full description
('Title' and 'Description') into the metadata file.
Metadata creation uses the latest package, i.e. highest version,
for which an ebuild has been created.</p>
</div>
<div class="section" id="manifest-creation">
<h3><a class="toc-backref" href="#contents">13.3.2&nbsp;&nbsp;&nbsp;Manifest Creation</a></h3>
<p>Manifest files are created by calling the <em>ebuild</em> executable for each
package directory in a filtered environment where FETCHCOMMAND and
RESUMECOMMAND are set to no-operation. The directories that contain the R
package files are passed in the PORTAGE_RO_DISTDIRS variable and DISTDIR
is set to <a class="reference internal" href="#distfiles-root">DISTFILES_ROOT</a>/__tmp__.</p>
</div>
</div>
<div class="section" id="ebuild-creation">
<h2><a class="toc-backref" href="#contents">13.4&nbsp;&nbsp;&nbsp;Ebuild Creation</a></h2>
<p>Ebuild creation is the process centered around one <em>PackageInfo</em> instance <em>p</em>
that tries to create an ebuild for it.</p>
<p>It does the following steps:</p>
<ol class="arabic simple">
<li>Read the DESCRIPTION file of <em>p</em> R package tarball and stores the
data in an associative array ('DESCRIPTION field' -&gt; 'data')</li>
<li>Call <a class="reference internal" href="#dependency-resolution">dependency resolution</a></li>
<li>If dependency resolution was successful, dependency ebuild variables are
created (<em>DEPEND</em>, <em>RDEPEND</em> and <em>R_SUGGESTS</em>, also <em>IUSE</em>, <em>MISSINGDEPS</em>).
Otherwise <strong>ebuild creation stops</strong> and <em>p</em> is marked as
<em>ebuild uncreatable</em>. The overlay creation may decide to remove <em>p</em> in
order to save memory etc.</li>
<li>The <em>DESCRIPTION</em> and <em>SRC_URI</em> variables are created</li>
<li>Add any ebuild variables created by package rules, e.g. <em>KEYWORDS</em></li>
<li><strong>done</strong> - Generate the ebuild as text, add it to <em>p</em> and mark <em>p</em>
as <em>ebuild successfully created</em></li>
</ol>
<div class="section" id="ebuild-variables">
<h3><a class="toc-backref" href="#contents">13.4.1&nbsp;&nbsp;&nbsp;Ebuild Variables</a></h3>
<p>Each ebuild variable is an object whose class is derived from the <em>EbuildVar</em>
class. An <em>EbuildVar</em> defines its position in the ebuild and  how its text
output should look like. Ebuild text is created by adding ebuild variables
to an <em>Ebuilder</em> that automatically sorts them and creates the ebuild.</p>
</div>
</div>
<div class="section" id="overlay-creation">
<h2><a class="toc-backref" href="#contents">13.5&nbsp;&nbsp;&nbsp;Overlay Creation</a></h2>
<p>Overlay creation is the process of creating an overlay for many R packages
and <em>roverlay</em>'s main task. More specifically, <em>OverlayCreation</em> is an
<em>R packages -&gt; Overlay (-&gt; overlay in filesystem)</em> interface.
It accepts <em>PackageInfo</em> objects as input, applies package rules to them,
which possibly filters some packages out, tries to reserve a slot in the
overlay for them, and, if successful, adds them to the work queue.</p>
<p>The work queue is processed by <em>OverlayWorkers</em> that run ebuild creation
for a <em>PackageInfo</em> object and inform the <em>OverlayCreation</em> about the result
afterwards. Overlay creation keeps going if an ebuild cannot be created,
instead the event is logged. Running more than one <em>OverlayWorker</em> in parallel
is possible.</p>
</div>
<div class="section" id="dependency-resolution">
<h2><a class="toc-backref" href="#contents">13.6&nbsp;&nbsp;&nbsp;Dependency Resolution</a></h2>
<p>Each ebuild creation process has access to the <em>dependency resolver</em> that
accepts <em>dependency strings</em>, tries to resolve them and returns the result,
either &quot;unresolvable&quot; or the resolving <em>dependency</em> as
<em>Dynamic DEPEND</em>/<em>DEPEND Atom</em>.</p>
<p>The ebuild creation uses <em>channels</em> for communication with the <em>dependency
resolver</em>, so-called <em>EbuildJobChannels</em> that handle the 'high-level'
string-to-string dependency resolution for a set of <em>dependency strings</em>.
Typically, one <em>channel</em> is used per ebuild variable (DEPEND, RDEPEND and
R_SUGGESTS).</p>
<p>From the ebuild creation perspective, dependency resolution works like this:</p>
<ol class="arabic simple">
<li>Collect the <em>dependency strings</em> from the DESCRIPTION data and add them
to the communication <em>channels</em> (up to 3 will be used)</li>
<li>Wait until all channels are <em>done</em></li>
<li><strong>Stop ebuild creation</strong> if a channel reports that it could not resolve
all <em>required dependencies</em>. No ebuild can be created in that case.</li>
<li><strong>Successfully done</strong> - transfer the channel results to ebuild variables</li>
</ol>
<p>Details about dependency resolution like how <em>channels</em> work can be found
in the following subsections.</p>
<div class="section" id="dependency-types">
<h3><a class="toc-backref" href="#contents">13.6.1&nbsp;&nbsp;&nbsp;Dependency types</a></h3>
<p>Every <em>dependency string</em> has a <em>dependency type</em> that declares how a
dependency should be resolved. It has one or more of these properties:</p>
<dl class="docutils">
<dt>Mandatory</dt>
<dd>Ebuild creation fails if the <em>dependency string</em> in question cannot
be resolved.</dd>
<dt>Optional</dt>
<dd>The opposite of <em>Mandatory</em>, ebuild creation keeps going even if the
<em>dependency string</em> is unresolvable.</dd>
<dt>Package Dependency</dt>
<dd>This declares that the <em>dependency string</em> could be another R package.</dd>
<dt>System Dependency</dt>
<dd>This declares that the <em>dependency string</em> could be a system dependency,
e.g. a scientific library or a video encoder.</dd>
<dt>Try other dependency types</dt>
<dd>This declares that the <em>dependency string</em> can be resolved by ignoring its
dependency type partially. This property allows to resolve package
dependencies as system dependencies and vice versa. Throughout this
document, such property is indicated by <em>TRY_OTHER</em> and
<em>&lt;preferred dependency type&gt; first</em>, e.g. <em>package first</em>.</dd>
</dl>
<p><em>Mandatory</em> and <em>Optional</em> are mutually exclusive.</p>
<p>The <em>dependency type</em> of a <em>dependency string</em> is determined by its origin,
i.e. info field in the package's DESCRIPTION file.
The <em>Suggests</em> field, for example, gets the
<em>&quot;package dependency only and optional&quot;</em> type, whereas the <em>SystemRequirements</em>
gets <em>&quot;system dependency, but try others, and mandatory&quot;</em>.</p>
<div class="section" id="description-file-dependency-fields">
<h4><a class="toc-backref" href="#contents">13.6.1.1&nbsp;&nbsp;&nbsp;DESCRIPTION file dependency fields</a></h4>
<p>The DESCRIPTION file of an R package contains several fields that list
dependencies on R packages or other software like scientific libraries.
This section describes which <em>dependency fields</em> are used and how.</p>
<table border="1" class="docutils">
<caption>R package dependency fields</caption>
<colgroup>
<col width="28%" />
<col width="31%" />
<col width="25%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">dependency field</th>
<th class="head">ebuild variable</th>
<th class="head">dependency type</th>
<th class="head">required</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Depends</td>
<td rowspan="2">DEPEND</td>
<td rowspan="2">package first</td>
<td rowspan="4"><em>yes</em></td>
</tr>
<tr><td>Imports</td>
</tr>
<tr><td>LinkingTo</td>
<td rowspan="2">RDEPEND</td>
<td>package first</td>
</tr>
<tr><td>SystemRequirements</td>
<td>system first</td>
</tr>
<tr><td rowspan="2">Suggests</td>
<td>R_SUGGESTS</td>
<td>package <strong>only</strong></td>
<td><strong>no</strong></td>
</tr>
<tr><td>_UNRESOLVED_PACKAGES</td>
<td><em>unresolvable</em></td>
<td><em>n/a</em></td>
</tr>
</tbody>
</table>
<p>A non-empty <em>R_SUGGESTS</em> ebuild variable will enable the <em>R_suggests</em> USE
flag. <em>R_SUGGESTS</em> is a runtime dependency (a <em>Dynamic DEPEND</em> in <em>RDEPEND</em>).</p>
<p>Ebuild creation keeps going if an optional dependency cannot be resolved.
This is not desirable for most <em>dependency fields</em>, but extremely
useful for R package suggestions that often link to other repositories or
private homepages.
Such unresolvable dependencies go into the <em>_UNRESOLVED_PACKAGES</em> ebuild
variable.
Whether and how this variable is used is up to the eclass file(s).
The default <em>R-packages eclass</em> reports unresolvable,
but optional dependencies during the <em>pkg_postinst()</em> ebuild phase.</p>
</div>
</div>
<div class="section" id="dependency-environments">
<h3><a class="toc-backref" href="#contents">13.6.2&nbsp;&nbsp;&nbsp;Dependency Environments</a></h3>
<p>A <em>dependency environment</em> is an object that reflects the whole dependency
resolution process of a single <em>dependency string</em>. It usually contains
the <em>dependency string</em>, its <em>dependency type</em>, information about its
resolution state (<em>resolved</em>, <em>unresolvable</em>, <em>to be processed</em>) and the
resolving resolving <em>dependency</em>, if any.</p>
<p>It is initialized by the communication <em>channel</em> and processed by the
<em>dependency resolver</em>.</p>
</div>
<div class="section" id="ebuildjob-channel">
<h3><a class="toc-backref" href="#contents">13.6.3&nbsp;&nbsp;&nbsp;EbuildJob Channel</a></h3>
<p>The <em>EbuildJob Channel</em> is used by the ebuild creation to communicate with
the <em>dependency resolver</em>. It is initialized by an ebuild creation process and
realizes a greedy <em>string to string</em> dependency resolution.</p>
<p>Its mode of operation is</p>
<ol class="arabic">
<li><p class="first">Accept <em>dependency strings</em>, create <em>dependency environments</em> for them
and add them to the registered <em>dependency resolver</em>.
The <em>dependency resolver</em> may already be resolving the added dependencies.</p>
<p>Leave this state if the ebuild creation signalizes that all <em>dependency
strings</em> have been added.</p>
</li>
<li><p class="first">Tell the <em>dependency resolver</em> that this channel is waiting for results.</p>
<p>The channel using a <em>blocking queue</em> for waiting. It expects that the
<em>dependency resolver</em> sends processed <em>dependency environments</em> though this
channel, whether successful or not.</p>
</li>
<li><p class="first">Process each received <em>dependency environment</em> until all dependencies have
been resolved or waiting does not make sense anymore, i.e. at least one
<em>required</em> dependency could not be resolved.</p>
<ul class="simple">
<li>add successful resolved dependencies to the &quot;resolved&quot; list</li>
<li>add unresolved, but optional dependencies to the &quot;unresolvable&quot; list</li>
<li>any other unresolved dependency is interpreted as &quot;channel cannot satisfy
the request&quot;, the <strong>channel stops waiting</strong> for remaining results.</li>
</ul>
</li>
<li><p class="first">The <em>channel</em> returns the result to the ebuild creation:</p>
<ul class="simple">
<li>a 2-tuple of resolved and unresolvable dependencies or</li>
<li>&quot;nothing&quot; if the request is not satisfiable, i.e. one or more required
dependencies are unresolvable.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="dependency-rule-pools">
<h3><a class="toc-backref" href="#contents">13.6.4&nbsp;&nbsp;&nbsp;Dependency Rule Pools</a></h3>
<p>The <em>dependency resolver</em> does not know <em>how</em> to resolve a <em>dependency string</em>.
Instead, it searches through a list of <em>dependency rule pools</em> that may be
able to do this.</p>
<p>A <em>dependency rule pool</em> combines a list of <em>dependency rules</em> with a
<em>dependency type</em> and is able to determine whether it accepts the type
of a <em>dependency string</em> or not.</p>
<p><em>Dependency rules</em> are objects with a &quot;matches&quot; function that returns the
<em>resolving dependency</em> if it matches the given <em>dependency string</em>, else
it returns &quot;cannot resolve&quot;. Note the difference between
&quot;a rule cannot resolve a dep string&quot; and &quot;dep string is unresolvable&quot;,
which means that no rule can resolve a particular <em>dependency string</em>.</p>
<p>See <a class="reference internal" href="#dependency-rules">Dependency Rules</a> for the concrete rules available.</p>
<p>Rule pools are normally created by reading rule files, but some rule pools
consist of rules that exist in memory only.
These are called <strong>Dynamic Rule Pools</strong> and use runtime data like &quot;all known
R packages&quot; to create rules.</p>
<p id="dynamic-selfdep-rule-pool"><em>roverlay</em> uses one dynamic rule pool, the <strong>Dynamic Selfdep Rule Pool</strong>.
This pool contains rules for all known R packages and is able to resolve
R package dependencies.
By convention, it will never resolve any system dependencies.</p>
</div>
<div class="section" id="dependency-resolver-modules">
<h3><a class="toc-backref" href="#contents">13.6.5&nbsp;&nbsp;&nbsp;Dependency Resolver Modules</a></h3>
<p>The dependency resolver can be extended by modules. Two base types are
available, <em>channels</em> and <em>listeners</em>.</p>
<dl class="docutils">
<dt>Listener modules</dt>
<dd><p class="first">Listener modules are used to react on certain dependency resolution
<em>events</em>, e.g. if a <em>dependency environment</em> is unresolvable.
They usually have access to the <em>event</em> and the <em>dependency environment</em>.
However, they cannot begin communication with the <em>dependency resolver</em>.</p>
<p class="last">In the current <em>roverlay</em> implementation, a listener module is used to
report all unresolvable dependencies to a separate file.</p>
</dd>
<dt>Channel modules</dt>
<dd><p class="first">Channel modules interact with the resolver, e.g. queue dependencies for
resolution, wait for results, and send them to the other end.</p>
<p class="last">The previously described <a class="reference internal" href="#ebuildjob-channel">EbuildJob Channel</a> is such a channel.</p>
</dd>
</dl>
</div>
<div class="section" id="dependency-resolver">
<h3><a class="toc-backref" href="#contents">13.6.6&nbsp;&nbsp;&nbsp;Dependency Resolver</a></h3>
<p>The dependency resolver puts all parts of dependency resolution together,
<em>rule pools</em>, <em>listeners</em> and <em>channels</em>. Its main task is a loop that
processes all queued <em>dependency environments</em> and sends the result back to
their origin (an <em>EbuildJob channel</em>).</p>
<p>Besides that, it also offers functionality to register new channels, add
listeners, load rule pools from one or more files etc..
A dependency resolver has to be explicitly closed in which case it will stop
working and notify all listeners about that.</p>
<p>Its mode of operation of operation is best described in pseudo-code:</p>
<pre class="code text literal-block">
while &lt;dependencies queued for resolution&gt;

   depenv   &lt;= get the next dependency environment
   resolved &lt;= False

   # try to resolve depenv

   if &lt;depenv's type contains PACKAGE&gt; and
   &lt;the dynamic selfdep rule pool resolves depenv&gt;

      resolved &lt;= True

   else
      if &lt;a rule pool accepts depenv's type and resolves depenv&gt;
         resolved &lt;= True

      else if &lt;depenv's type contains TRY_OTHER&gt;

         if &lt;a rule pool supports TRY_OTHER and does not accept depenv's type and resolves depenv&gt;

            resolved &lt;= True
      end if
   end if


   # send the result to depenv's channel

   if resolved
      mark depenv as resolved, add the resolving dependency to it

   else
      mark depenv as unresolvable

   end if

   send depenv to its channel

end while
</pre>
<p>The dependency resolver can be <strong>run as thread</strong>, in which case the while loop
becomes &quot;loop until resolver closes&quot;.</p>
</div>
</div>
</div>
</div>
<div class="footer">
<hr class="footer" />
Generated on: 2013-06-26.

</div>
</body>
</html>
